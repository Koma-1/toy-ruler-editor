(()=>{"use strict";class t{constructor(t,e,i,s){this.id=t,this.start=e,this.end=i,this.graphicsAttributes=s}getBBox(){const t=this.start.getPosition(),e=this.end.getPosition();return t.x<e.x?t.x:e.x,t.y<e.y?t.y:e.y,{x:Math.min(t.x,e.x),y:Math.min(t.y,e.y),width:Math.abs(t.x-e.x),height:Math.abs(t.y-e.y)}}}class e{constructor(t,e,i,s){this.id=t,this.direction=e,this.baseRuler=i,this.offset=s,this.previewOffset=null}getPosition(){var t,e;return this.baseRuler?this.baseRuler.getPosition()+this.offset+(null!==(t=this.previewOffset)&&void 0!==t?t:0):this.offset+(null!==(e=this.previewOffset)&&void 0!==e?e:0)}applyPreviewOffset(t){this.previewOffset=t+this.offset>=0?t:-this.offset}commitPreview(){null!==this.previewOffset&&(this.offset+=this.previewOffset,this.previewOffset=null)}cancelPreview(){this.previewOffset=null}}class i{constructor(t,e){this.xRuler=t,this.yRuler=e}getPosition(){return{x:this.xRuler.getPosition(),y:this.yRuler.getPosition()}}}class s{constructor(t){this.pos=t}getPosition(){return this.pos}}class n{constructor(t=[],e=[]){this.rulers=new Map,this.elements=[];for(const e of t)this.rulers.set(e.id,e);this.elements=e}getRuler(t){return this.rulers.get(t)}getAllRulers(){return Array.from(this.rulers.values())}getAllIntersections(){let t=[];for(const e of this.getAllRulers().filter((t=>"vertical"===t.direction)))for(const i of this.getAllRulers().filter((t=>"horizontal"===t.direction)))t.push({xRuler:e,yRuler:i});return t}getElements(){return this.elements}addElement(t){this.elements.push(t)}removeElementById(t){this.elements=this.elements.filter((e=>e.id!==t))}}class r{constructor(){this.rulerMap=new Map,this.rectMap=new Map,this.rectList=[]}parse(t){if(t.length>5e4)throw"Input XML is too large.";const e=(new DOMParser).parseFromString(t,"application/xml");e.querySelector("parsererror")?console.log("parse error"):console.log(e.documentElement.nodeName);for(const t of Array.from(e.documentElement.children))switch(t.tagName){case"ruler":this.parseRulerTag(t);break;case"rect":this.parseRectTag(t)}return new n(Array.from(this.rulerMap.values()),this.rectList)}parseRulerTag(t){const e=t.getAttribute("id"),i=t.getAttribute("direction"),s=t.getAttribute("type");if(!e||!i||!s)throw"TODO";if(this.rulerMap.has(e))throw"TODO";if("horizontal"!=i&&"vertical"!=i)throw"TODO";if("chain"!=s)throw"TODO";this.parseChainedRulerTag(t,e,i)}parseChainedRulerTag(t,i,s){const n=t.getAttribute("offsetFrom"),r=t.getAttribute("offset");if(!r)throw"TODO";const o=Number(r);if(Number.isNaN(o))throw"TODO";if(n){const t=this.rulerMap.get(n);if(!t)throw"TODO";if(t.direction!=s)throw"TODO";this.rulerMap.set(i,new e(i,s,t,o))}else this.rulerMap.set(i,new e(i,s,null,o))}parseRectTag(e){const n=e.getAttribute("id");if(!n)throw"TODO";const r=e.getAttribute("startXRuler"),o=e.getAttribute("startYRuler"),h=e.getAttribute("startX"),a=e.getAttribute("startY");let l=null;if(r&&o&&!h&&!a){const t=this.rulerMap.get(r),e=this.rulerMap.get(o);if(!t||!e)throw"TODO";if("vertical"!=t.direction||"horizontal"!=e.direction)throw"TODO";l=new i(t,e)}else{if(r||o||!h||!a)throw"TODO";{const t=Number(h),e=Number(a);if(Number.isNaN(t)||Number.isNaN(e))throw"TODO";l=new s({x:t,y:e})}}if(!l)throw"TODO";const c=e.getAttribute("endXRuler"),d=e.getAttribute("endYRuler"),g=e.getAttribute("endX"),u=e.getAttribute("endY");let m=null;if(c&&d&&!g&&!u){const t=this.rulerMap.get(c),e=this.rulerMap.get(d);if(!t||!e)throw"TODO";if("vertical"!=t.direction||"horizontal"!=e.direction)throw"TODO";m=new i(t,e)}else{if(c||d||!g||!u)throw"TODO";{const t=Number(g),e=Number(u);if(Number.isNaN(t)||Number.isNaN(e))throw"TODO";m=new s({x:t,y:e})}}if(!m)throw"TODO";const v=new t(n,l,m);this.rectList.push(v),this.rectMap.set(n,v)}}const o="http://www.w3.org/2000/svg";function h(t,e,i){return new DOMPoint(e,i).matrixTransform(t.getScreenCTM().inverse())}class a{constructor(t,e){this.container=t,this.model=e,this.svgRoot=document.createElementNS(o,"svg"),this.container.appendChild(this.svgRoot)}setScreenSize(t,e){this.container.style.width=String(t),this.container.style.height=String(e)}setEditorPlaneSize(t,e){this.svgRoot.setAttribute("width",String(t)),this.svgRoot.setAttribute("height",String(e))}setScroll(t){}setZoom(t){}render(){}}class l{constructor(t,e,i){this.svgRoot=t,this.model=e,this.context=i}render(){for(;this.svgRoot.firstChild;)this.svgRoot.removeChild(this.svgRoot.firstChild);const t=document.createElementNS(o,"rect");t.setAttribute("x","0"),t.setAttribute("y","0"),t.setAttribute("width",String(this.context.getSvgWidth())),t.setAttribute("height",String(this.context.getSvgHeight())),t.setAttribute("fill","transparent"),t.setAttribute("pointer-events","all"),this.svgRoot.appendChild(t);const e=document.createElementNS(o,"g");this.svgRoot.appendChild(e),t.addEventListener("mousemove",(t=>{const i=h(this.svgRoot,t.clientX,t.clientY);this.updateHoveredIntersections({x:i.x-this.context.getCanvasMargins().left,y:i.y-this.context.getCanvasMargins().top},e)}))}updateHoveredIntersections(t,e){for(;e.firstChild;)e.removeChild(e.firstChild);const s=this.model.getAllIntersections(),n=this.context.getZoom(),r=10/n;let h=-1,a=Number.MAX_VALUE;for(const[e,i]of s.entries()){const s=Math.abs(t.x-i.xRuler.getPosition()),o=Math.abs(t.y-i.yRuler.getPosition());s*n<r&&o*n<r&&s*s+o*o<a&&(h=e,a=s*s+o*o)}if(-1!=h){const t=s[h],n=document.createElementNS(o,"circle");n.setAttribute("cx",String(t.xRuler.getPosition()+this.context.getCanvasMargins().left)),n.setAttribute("cy",String(t.yRuler.getPosition()+this.context.getCanvasMargins().top)),n.setAttribute("r",String(r)),n.setAttribute("fill","#FF00FF"),n.addEventListener("click",(e=>{this.context.controller.push({type:"pointSelected",point:new i(t.xRuler,t.yRuler)})})),e.appendChild(n)}}}class c{constructor(t,e){this.model=t,this.root=e,this.dom=null}render(){this.dom||(this.dom=document.createElementNS(o,"rect"),this.root.appendChild(this.dom));const{x:t,y:e,width:i,height:s}=this.model.getBBox();this.dom.setAttribute("x",String(t)),this.dom.setAttribute("y",String(e)),this.dom.setAttribute("width",String(i)),this.dom.setAttribute("height",String(s)),this.dom.setAttribute("fill","lightgray")}}class d{constructor(t,e,i){this.ruler=t,this.context=e,this.root=i,this.dom=null,this.baseStrokeWidth=1,this.svgStrokeWidth=1}setZoom(t){this.svgStrokeWidth=this.baseStrokeWidth/t,this.render()}render(){const t=this.ruler.getPosition();this.dom||(this.dom=document.createElementNS(o,"line"),this.root.appendChild(this.dom)),"horizontal"===this.ruler.direction?(this.dom.setAttribute("x1","0"),this.dom.setAttribute("y1",String(t+this.context.getCanvasMargins().top)),this.dom.setAttribute("x2",String(this.context.getCanvasMargins().left+this.context.getCanvasWidth()+this.context.getCanvasMargins().right)),this.dom.setAttribute("y2",String(t+this.context.getCanvasMargins().top)),this.dom.setAttribute("stroke","#00FF00")):(this.dom.setAttribute("x1",String(t+this.context.getCanvasMargins().left)),this.dom.setAttribute("y1","0"),this.dom.setAttribute("x2",String(t+this.context.getCanvasMargins().left)),this.dom.setAttribute("y2",String(this.context.getCanvasMargins().top+this.context.getCanvasHeight()+this.context.getCanvasMargins().bottom)),this.dom.setAttribute("stroke","#FF0000")),this.dom.setAttribute("stroke-width",String(this.svgStrokeWidth))}}class g{constructor(t,e,i){this.ruler=t,this.context=e,this.root=i,this.dom=null,this.baseStrokeWidth=10,this.svgStrokeWidth=10}setZoom(t){this.svgStrokeWidth=this.baseStrokeWidth/t,this.render()}render(){const t=this.ruler.getPosition();this.dom||(this.dom=document.createElementNS(o,"line"),this.root.appendChild(this.dom),this.ruler instanceof e&&this.dom.addEventListener("mousedown",(t=>{var e;this.onStartDragCallback,null===(e=this.onStartDragCallback)||void 0===e||e.call(this,this.ruler,t)}))),"horizontal"===this.ruler.direction?(this.dom.setAttribute("x1","0"),this.dom.setAttribute("y1",String(t+this.context.getCanvasMargins().top)),this.dom.setAttribute("x2",String(this.context.getCanvasMargins().left+this.context.getCanvasWidth()+this.context.getCanvasMargins().right)),this.dom.setAttribute("y2",String(t+this.context.getCanvasMargins().top)),this.dom.setAttribute("stroke","#00FF00")):(this.dom.setAttribute("x1",String(t+this.context.getCanvasMargins().left)),this.dom.setAttribute("y1","0"),this.dom.setAttribute("x2",String(t+this.context.getCanvasMargins().left)),this.dom.setAttribute("y2",String(this.context.getCanvasMargins().top+this.context.getCanvasHeight()+this.context.getCanvasMargins().bottom)),this.dom.setAttribute("stroke","#FF0000")),this.dom.setAttribute("stroke-width",String(this.svgStrokeWidth))}onStartDrag(t){this.onStartDragCallback=t}}class u{constructor(t,e,i){this.container=t,this.model=e,this.context=i,this.svgRoot=document.createElementNS(o,"svg"),this.container.appendChild(this.svgRoot),this.drawingGroup=document.createElementNS(o,"g"),this.svgRoot.appendChild(this.drawingGroup),this.backgroundPlane=document.createElementNS(o,"g"),this.contentPlane=document.createElementNS(o,"g"),this.rulerPlane=document.createElementNS(o,"g"),this.intersectionPlane=document.createElementNS(o,"g"),this.drawingGroup.appendChild(this.backgroundPlane),this.drawingGroup.appendChild(this.contentPlane),this.drawingGroup.appendChild(this.rulerPlane),this.drawingGroup.appendChild(this.intersectionPlane)}setScreenSize(t,e){this.container.style.width=String(t),this.container.style.height=String(e)}render(){for(this.svgRoot.setAttribute("width",String(this.context.getSvgWidth())),this.svgRoot.setAttribute("height",String(this.context.getSvgHeight())),this.drawingGroup.style.transformOrigin="top left",this.drawingGroup.style.transform=`scale(${String(this.context.getZoom())})`;this.backgroundPlane.firstChild;)this.backgroundPlane.removeChild(this.backgroundPlane.firstChild);for(;this.contentPlane.firstChild;)this.contentPlane.removeChild(this.contentPlane.firstChild);for(;this.rulerPlane.firstChild;)this.rulerPlane.removeChild(this.rulerPlane.firstChild);this.contentPlane.style.transformOrigin="top left",this.contentPlane.style.transform=`translate(${this.context.getCanvasMargins().left}px, ${this.context.getCanvasMargins().top}px)`,this.addBackground(this.backgroundPlane);for(const t of this.model.getElements())new c(t,this.contentPlane).render();for(const t of this.model.getAllRulers()){const e=new d(t,this.context,this.rulerPlane);e.setZoom(this.context.getZoom()),e.render()}new l(this.intersectionPlane,this.model,this.context).render()}addBackground(t){const e=this.context.getCanvasMargins(),i=this.context.getCanvasWidth(),s=this.context.getCanvasHeight(),n=e.left+i+e.right,r=e.top+s+e.bottom,h=document.createElementNS(o,"rect");h.setAttribute("x","0"),h.setAttribute("y","0"),h.setAttribute("width",String(n)),h.setAttribute("height",String(r)),h.setAttribute("fill","darkgray");const a=document.createElementNS(o,"rect");a.setAttribute("x",String(e.left)),a.setAttribute("y",String(e.left)),a.setAttribute("width",String(i)),a.setAttribute("height",String(s)),a.setAttribute("fill","white"),t.appendChild(h),t.appendChild(a)}}class m{constructor(t,e,i,s,n){this.hContainer=t,this.vContainer=e,this.model=i,this.context=s,this.requestRenderCallback=n,this.draggingRuler=null,this.dragStartPoint=null,this.animationFrameId=null,this.hSvgRoot=document.createElementNS(o,"svg"),this.vSvgRoot=document.createElementNS(o,"svg"),this.hContainer.appendChild(this.hSvgRoot),this.vContainer.appendChild(this.vSvgRoot),this.hDrawingPlane=document.createElementNS(o,"g"),this.vDrawingPlane=document.createElementNS(o,"g"),this.hSvgRoot.appendChild(this.hDrawingPlane),this.vSvgRoot.appendChild(this.vDrawingPlane),this.attachEventListeners()}setRulerAreaSize(t,e,i){this.hContainer.style.width=String(i),this.hContainer.style.height=String(e),this.vContainer.style.width=String(t),this.vContainer.style.height=String(i)}attachEventListeners(){this.vContainer.addEventListener("mousemove",(t=>{this.onMouseMove(t)})),this.hContainer.addEventListener("mousemove",(t=>{this.onMouseMove(t)})),this.vContainer.addEventListener("mouseup",(t=>{this.onMouseUp(t)})),this.hContainer.addEventListener("mouseup",(t=>{this.onMouseUp(t)}))}handleStartDrag(t,e){switch(e.preventDefault(),this.draggingRuler=t,t.direction){case"horizontal":this.dragStartPoint=h(this.hDrawingPlane,e.clientX,e.clientY);break;case"vertical":this.dragStartPoint=h(this.vDrawingPlane,e.clientX,e.clientY)}}onMouseMove(t){if(!this.draggingRuler)return;const e=h("horizontal"===this.draggingRuler.direction?this.hDrawingPlane:this.vDrawingPlane,t.clientX,t.clientY),i="horizontal"===this.draggingRuler.direction?e.y-this.dragStartPoint.y:e.x-this.dragStartPoint.x;this.draggingRuler.applyPreviewOffset(i),this.requestRender()}onMouseUp(t){this.draggingRuler&&(this.draggingRuler.commitPreview(),this.draggingRuler=null,this.cancelRenderLoop(),this.requestRenderCallback())}render(){for(this.vSvgRoot.setAttribute("width",String(this.context.getSvgWidth()+100)),this.vSvgRoot.setAttribute("height",String(this.vContainer.clientHeight)),this.hSvgRoot.setAttribute("width",String(this.hContainer.clientWidth)),this.hSvgRoot.setAttribute("height",String(this.context.getSvgWidth()+100)),this.hDrawingPlane.style.transformOrigin="top left",this.vDrawingPlane.style.transformOrigin="top left",this.hDrawingPlane.style.transform=`scale(1.0, ${String(this.context.getZoom())})`,this.vDrawingPlane.style.transform=`scale(${String(this.context.getZoom())}, 1.0)`;this.hDrawingPlane.firstChild;)this.hDrawingPlane.removeChild(this.hDrawingPlane.firstChild);for(;this.vDrawingPlane.firstChild;)this.vDrawingPlane.removeChild(this.vDrawingPlane.firstChild);for(const t of this.model.getAllRulers())if("horizontal"==t.direction){const e=new g(t,this.context,this.hDrawingPlane);e.setZoom(this.context.getZoom()),e.onStartDrag(((t,e)=>this.handleStartDrag(t,e))),e.render()}else if("vertical"==t.direction){const e=new g(t,this.context,this.vDrawingPlane);e.setZoom(this.context.getZoom()),e.onStartDrag(((t,e)=>this.handleStartDrag(t,e))),e.render()}}requestRender(){null===this.animationFrameId&&(this.animationFrameId=requestAnimationFrame((()=>{this.animationFrameId=null,this.requestRenderCallback()})))}cancelRenderLoop(){null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}}class v{constructor(t,e){this.controller=t,this.model=e,this.stage="start"}getMode(){return"insert-rect"}push(e){if(console.log("InsertRectState push:",e),console.log("stage:",this.stage),"cancel"!=e.type){if("pointSelected"==e.type)if("start"===this.stage)this.startPoint=e.point,this.stage="end";else{const i=new t("__Rect",this.startPoint,e.point);this.model.addElement(i),this.controller.exit()}}else this.controller.exit()}}class p{constructor(t,e,i){this.container=t,this.model=e,this.context=i}render(){for(;this.container.firstChild;)this.container.removeChild(this.container.firstChild);const t=document.createElement("button");this.container.appendChild(t),t.innerText="Zoom Up",t.addEventListener("click",(t=>{this.context.setZoom(this.context.getZoom()+.1),this.context.requestRender()}));const e=document.createElement("button");this.container.appendChild(e),e.innerText="Zoom Reset",e.addEventListener("click",(t=>{this.context.resetZoom(),this.context.requestRender()}));const i=document.createElement("button");this.container.appendChild(i),i.innerText="Zoom Down",i.addEventListener("click",(t=>{this.context.setZoom(this.context.getZoom()-.1),this.context.requestRender()}));const s=document.createElement("button");s.innerText="Cancel",s.addEventListener("click",(t=>{this.context.controller.push({type:"cancel"})})),this.container.appendChild(s);const n=document.createElement("button");n.innerText="Add Rect",n.addEventListener("click",(t=>{this.context.controller.setState(new v(this.context.controller,this.model))})),this.container.appendChild(n)}}class f{constructor(t,e,i){for(this.container=t,this.model=e,this.context=i,this.context.setRenderCallback((()=>{this.render()}));this.container.firstChild;)this.container.removeChild(this.container.firstChild);const[s,n,r,o,h]=this.createLayout();this.editorPlaneView=new u(s,this.model,this.context),this.rulerAreaView=new m(n,r,e,this.context,(()=>this.render())),this.cornerRulerAreaView=new a(o,this.model),this.toolBarView=new p(h,this.model,this.context),this.setScreenSize(500,500,50)}createLayout(){const[t,e,i,s,n]=this.createContainers();this.setupScrollSync(t,e,i);const r=document.createElement("div");r.setAttribute("id","editorRow1"),r.appendChild(s),r.appendChild(i);const o=document.createElement("div");return o.setAttribute("id","editorRow2"),o.appendChild(e),o.appendChild(t),this.container.appendChild(r),this.container.appendChild(o),this.container.appendChild(n),[t,e,i,s,n]}createContainers(){const t=document.createElement("div"),e=document.createElement("div"),i=document.createElement("div"),s=document.createElement("div"),n=document.createElement("div");return t.setAttribute("id","editorPlaneContainer"),e.setAttribute("id","hRulerAreaContainer"),i.setAttribute("id","vRulerAreaContainer"),s.setAttribute("id","cornerRulerAreaContainer"),t.style.display="inline-block",e.style.display="inline-block",i.style.display="inline-block",s.style.display="inline-block",t.style.overflow="scroll",e.style.overflow="hidden",i.style.overflow="hidden",s.style.overflow="hidden",[t,e,i,s,n]}render(){this.editorPlaneView.render(),this.rulerAreaView.render(),this.cornerRulerAreaView.render(),this.toolBarView.render()}setupScrollSync(t,e,i){t.addEventListener("scroll",(()=>{i.scrollLeft=t.scrollLeft,e.scrollTop=t.scrollTop}))}setScreenSize(t,e,i){this.editorPlaneView.setScreenSize(t,e),this.rulerAreaView.setRulerAreaSize(t,e,i),this.cornerRulerAreaView.setScreenSize(i,i)}}class S{constructor(){}getMode(){return"idle"}push(){}}class w{constructor(t){this.renderCallback=t,this.childState=new S}requestRender(){this.renderCallback()}getMode(){return this.childState.getMode()}push(t){console.log("EditorInteractionContoroller push:",t),this.childState.push(t)}exit(){this.requestRender(),this.childState=new S}setState(t){return console.log(this.childState.getMode()),"idle"===this.getMode()&&(console.log("->",t.getMode()),this.childState=t,!0)}cancel(){this.push({type:"cancel"})}}class b{constructor(){this.zoom=1,this.canvasWidth=640,this.canvasHeight=480,this.canvasMarginTop=400,this.canvasMarginRight=400,this.canvasMarginBottom=400,this.canvasMarginLeft=400,this.controller=new w((()=>{this.requestRender()})),this.renderCallback=()=>{}}setRenderCallback(t){this.renderCallback=t}requestRender(){this.renderCallback()}getZoom(){return this.zoom}setZoom(t){this.zoom=t}resetZoom(){this.setZoom(1)}getCanvasMargins(){return{top:this.canvasMarginTop,right:this.canvasMarginRight,bottom:this.canvasMarginBottom,left:this.canvasMarginLeft}}getCanvasWidth(){return this.canvasWidth}getCanvasHeight(){return this.canvasHeight}setCanvasSize(t,e){this.canvasWidth=t,this.canvasHeight=e}getSvgWidth(){return(this.canvasMarginLeft+this.canvasWidth+this.canvasMarginRight)*this.zoom}getSvgHeight(){return(this.canvasMarginTop+this.canvasHeight+this.canvasMarginBottom)*this.zoom}}const C=document.getElementById("editorScreen"),x=document.getElementById("xmlInput"),A=document.getElementById("loadButton");let R=null;A.addEventListener("click",(()=>{const t=x.value;try{const e=(new r).parse(t),i=new b;R=new f(C,e,i),R.render()}catch(t){console.error("XML parsing/rendering failed:",t),alert("XML parsing/rendering failed.")}}))})();