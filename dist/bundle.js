(()=>{"use strict";class t{constructor(t,e,i,n){this.id=t,this.start=e,this.end=i,this.graphicsAttributes=n}getBBox(){const t=this.start.getPosition(),e=this.end.getPosition();return t.x<e.x?t.x:e.x,t.y<e.y?t.y:e.y,{x:Math.min(t.x,e.x),y:Math.min(t.y,e.y),width:Math.abs(t.x-e.x),height:Math.abs(t.y-e.y)}}}class e{constructor(t,e,i,n){this.id=t,this.direction=e,this.baseRuler=i,this.offset=n,this.previewOffset=null}getPosition(){var t,e;return this.baseRuler?this.baseRuler.getPosition()+this.offset+(null!==(t=this.previewOffset)&&void 0!==t?t:0):this.offset+(null!==(e=this.previewOffset)&&void 0!==e?e:0)}applyPreviewOffset(t){this.previewOffset=t+this.offset>=0?t:-this.offset}commitPreview(){null!==this.previewOffset&&(this.offset+=this.previewOffset,this.previewOffset=null)}cancelPreview(){this.previewOffset=null}}class i{constructor(t,e){this.xRuler=t,this.yRuler=e}getPosition(){return{x:this.xRuler.getPosition(),y:this.yRuler.getPosition()}}}class n{constructor(t){this.pos=t}getPosition(){return this.pos}}class s{constructor(t,e,i=[],n=[]){this.width=t,this.height=e,this.rulers=new Map,this.elements=[];for(const t of i)this.rulers.set(t.id,t);this.elements=n}getRuler(t){return this.rulers.get(t)}getAllRulers(){return Array.from(this.rulers.values())}getAllIntersections(){let t=[];for(const e of this.getAllRulers().filter((t=>"vertical"===t.direction)))for(const i of this.getAllRulers().filter((t=>"horizontal"===t.direction)))t.push({xRuler:e,yRuler:i});return t}getElements(){return this.elements}addElement(t){this.elements.push(t)}removeElementById(t){this.elements=this.elements.filter((e=>e.id!==t))}getWidth(){var t;return null!==(t=this.width)&&void 0!==t?t:0}getHeight(){var t;return null!==(t=this.height)&&void 0!==t?t:0}}class r{constructor(){this.rulerMap=new Map,this.rectMap=new Map,this.rectList=[]}parse(t){if(t.length>5e4)throw"Input XML is too large.";const e=(new DOMParser).parseFromString(t,"application/xml");e.querySelector("parsererror")&&console.log("parse error");for(const t of e.documentElement.attributes)if("width"===t.name){const e=Number(t.value);if(Number.isNaN(e))throw"nan";this.width=e}else if("height"===t.name){const e=Number(t.value);if(Number.isNaN(e))throw"nan";this.height=e}for(const t of Array.from(e.documentElement.children))switch(t.tagName){case"ruler":this.parseRulerTag(t);break;case"rect":this.parseRectTag(t)}return new s(this.width,this.height,Array.from(this.rulerMap.values()),this.rectList)}parseRulerTag(t){const e=t.getAttribute("id"),i=t.getAttribute("direction"),n=t.getAttribute("type");if(!e||!i||!n)throw"TODO";if(this.rulerMap.has(e))throw"TODO";if("horizontal"!=i&&"vertical"!=i)throw"TODO";if("chain"!=n)throw"TODO";this.parseChainedRulerTag(t,e,i)}parseChainedRulerTag(t,i,n){const s=t.getAttribute("offsetFrom"),r=t.getAttribute("offset");if(!r)throw"TODO";const o=Number(r);if(Number.isNaN(o))throw"TODO";if(s){const t=this.rulerMap.get(s);if(!t)throw"TODO";if(t.direction!=n)throw"TODO";this.rulerMap.set(i,new e(i,n,t,o))}else this.rulerMap.set(i,new e(i,n,null,o))}parseRectTag(e){const s=e.getAttribute("id");if(!s)throw"TODO";const r=e.getAttribute("startXRuler"),o=e.getAttribute("startYRuler"),h=e.getAttribute("startX"),a=e.getAttribute("startY");let l=null;if(r&&o&&!h&&!a){const t=this.rulerMap.get(r),e=this.rulerMap.get(o);if(!t||!e)throw"TODO";if("vertical"!=t.direction||"horizontal"!=e.direction)throw"TODO";l=new i(t,e)}else{if(r||o||!h||!a)throw"TODO";{const t=Number(h),e=Number(a);if(Number.isNaN(t)||Number.isNaN(e))throw"TODO";l=new n({x:t,y:e})}}if(!l)throw"TODO";const c=e.getAttribute("endXRuler"),d=e.getAttribute("endYRuler"),g=e.getAttribute("endX"),u=e.getAttribute("endY");let m=null;if(c&&d&&!g&&!u){const t=this.rulerMap.get(c),e=this.rulerMap.get(d);if(!t||!e)throw"TODO";if("vertical"!=t.direction||"horizontal"!=e.direction)throw"TODO";m=new i(t,e)}else{if(c||d||!g||!u)throw"TODO";{const t=Number(g),e=Number(u);if(Number.isNaN(t)||Number.isNaN(e))throw"TODO";m=new n({x:t,y:e})}}if(!m)throw"TODO";const p=new t(s,l,m);this.rectList.push(p),this.rectMap.set(s,p)}}const o="http://www.w3.org/2000/svg";function h(t,e,i){return new DOMPoint(e,i).matrixTransform(t.getScreenCTM().inverse())}class a{constructor(t,e,i){this.container=t,this.model=e,this.context=i,this.svgRoot=document.createElementNS(o,"svg"),this.container.appendChild(this.svgRoot)}static createAndAttach(t,e,i){const n=document.createElement("div");return n.setAttribute("id","cornersRulerAreaContainer"),n.style.display="inline-block",n.style.overflow="hidden",t.appendChild(n),new a(n,e,i)}setScreenSize(t,e){this.container.style.width=String(t),this.container.style.height=String(e)}setEditorPlaneSize(t,e){this.svgRoot.setAttribute("width",String(t)),this.svgRoot.setAttribute("height",String(e))}setScroll(t){}setZoom(t){}render(){}}class l{constructor(t,e,i){this.svgRoot=t,this.model=e,this.context=i,this.pointLayer=document.createElementNS("http://www.w3.org/2000/svg","g")}render(){for(;this.svgRoot.firstChild;)this.svgRoot.removeChild(this.svgRoot.firstChild);if(!this.context.pointPicker.enabled)return;const t=document.createElementNS(o,"rect");t.setAttribute("x","0"),t.setAttribute("y","0"),t.setAttribute("width",String(this.context.getSvgWidth())),t.setAttribute("height",String(this.context.getSvgHeight())),t.setAttribute("fill","transparent"),t.setAttribute("pointer-events","all"),this.svgRoot.appendChild(t),this.pointLayer=document.createElementNS(o,"g"),this.svgRoot.appendChild(this.pointLayer),t.addEventListener("mousemove",(t=>{const e=h(this.svgRoot,t.clientX,t.clientY);this.updateHoveredIntersections({x:e.x-this.context.getCanvasMargins().left,y:e.y-this.context.getCanvasMargins().top},this.pointLayer)}))}updateHoveredIntersections(t,e){for(;e.firstChild;)e.removeChild(e.firstChild);const s=this.context.getZoom(),r=10/s;if(this.context.pointPicker.isSnap){const n=this.model.getAllIntersections();let h=-1,a=Number.MAX_VALUE;for(const[e,i]of n.entries()){const n=Math.abs(t.x-i.xRuler.getPosition()),o=Math.abs(t.y-i.yRuler.getPosition());n*s<r&&o*s<r&&n*n+o*o<a&&(h=e,a=n*n+o*o)}if(-1!=h){const t=n[h],s=document.createElementNS(o,"circle");s.setAttribute("cx",String(t.xRuler.getPosition()+this.context.getCanvasMargins().left)),s.setAttribute("cy",String(t.yRuler.getPosition()+this.context.getCanvasMargins().top)),s.setAttribute("r",String(r)),s.setAttribute("fill","#FF00FF"),s.addEventListener("click",(e=>{this.context.pushEvent({type:"pointSelected",point:new i(t.xRuler,t.yRuler)})})),e.appendChild(s)}}else{const i=document.createElementNS(o,"circle");i.setAttribute("cx",String(t.x+this.context.getCanvasMargins().left)),i.setAttribute("cy",String(t.y+this.context.getCanvasMargins().top)),i.setAttribute("r",String(r)),i.setAttribute("fill","#FF00FF"),i.setAttribute("pointer-events","click"),i.addEventListener("click",(e=>{this.context.pushEvent({type:"pointSelected",point:new n({x:t.x,y:t.y})})})),i.addEventListener("mousemove",(t=>{const e=h(this.svgRoot,t.clientX,t.clientY);this.updateHoveredIntersections({x:e.x-this.context.getCanvasMargins().left,y:e.y-this.context.getCanvasMargins().top},this.pointLayer)})),e.appendChild(i)}}}class c{constructor(t,e){this.model=t,this.root=e,this.dom=null}render(){this.dom||(this.dom=document.createElementNS(o,"rect"),this.root.appendChild(this.dom));const{x:t,y:e,width:i,height:n}=this.model.getBBox();this.dom.setAttribute("x",String(t)),this.dom.setAttribute("y",String(e)),this.dom.setAttribute("width",String(i)),this.dom.setAttribute("height",String(n)),this.dom.setAttribute("fill","lightgray")}}class d{constructor(t,e,i){this.ruler=t,this.context=e,this.root=i,this.dom=null,this.baseStrokeWidth=1,this.svgStrokeWidth=1}setZoom(t){this.svgStrokeWidth=this.baseStrokeWidth/t,this.render()}render(){const t=this.ruler.getPosition();this.dom||(this.dom=document.createElementNS(o,"line"),this.root.appendChild(this.dom)),"horizontal"===this.ruler.direction?(this.dom.setAttribute("x1","0"),this.dom.setAttribute("y1",String(t+this.context.getCanvasMargins().top)),this.dom.setAttribute("x2",String(this.context.getCanvasMargins().left+this.context.getCanvasWidth()+this.context.getCanvasMargins().right)),this.dom.setAttribute("y2",String(t+this.context.getCanvasMargins().top)),this.dom.setAttribute("stroke","#00FF00")):(this.dom.setAttribute("x1",String(t+this.context.getCanvasMargins().left)),this.dom.setAttribute("y1","0"),this.dom.setAttribute("x2",String(t+this.context.getCanvasMargins().left)),this.dom.setAttribute("y2",String(this.context.getCanvasMargins().top+this.context.getCanvasHeight()+this.context.getCanvasMargins().bottom)),this.dom.setAttribute("stroke","#FF0000")),this.dom.setAttribute("stroke-width",String(this.svgStrokeWidth))}}class g{constructor(t,e,i){this.container=t,this.model=e,this.context=i,this.svgRoot=document.createElementNS(o,"svg"),this.container.appendChild(this.svgRoot),this.drawingGroup=document.createElementNS(o,"g"),this.svgRoot.appendChild(this.drawingGroup),this.backgroundPlane=document.createElementNS(o,"g"),this.contentPlane=document.createElementNS(o,"g"),this.rulerPlane=document.createElementNS(o,"g"),this.intersectionPlane=document.createElementNS(o,"g"),this.drawingGroup.appendChild(this.backgroundPlane),this.drawingGroup.appendChild(this.contentPlane),this.drawingGroup.appendChild(this.rulerPlane),this.drawingGroup.appendChild(this.intersectionPlane),this.container.addEventListener("scroll",(()=>{var t;null===(t=this.onScroll)||void 0===t||t.call(this,this.container.scrollLeft,this.container.scrollTop)}))}setScrollListener(t){this.onScroll=t}static createAndAttach(t,e,i){const n=document.createElement("div");return n.id="editorPlaneContainer",n.style.overflow="scroll",n.style.display="inline-block",t.appendChild(n),new g(n,e,i)}setScreenSize(t,e){this.container.style.width=String(t),this.container.style.height=String(e)}render(){for(this.svgRoot.setAttribute("width",String(this.context.getSvgWidth())),this.svgRoot.setAttribute("height",String(this.context.getSvgHeight())),this.drawingGroup.style.transformOrigin="top left",this.drawingGroup.style.transform=`scale(${String(this.context.getZoom())})`;this.backgroundPlane.firstChild;)this.backgroundPlane.removeChild(this.backgroundPlane.firstChild);for(;this.contentPlane.firstChild;)this.contentPlane.removeChild(this.contentPlane.firstChild);for(;this.rulerPlane.firstChild;)this.rulerPlane.removeChild(this.rulerPlane.firstChild);this.contentPlane.style.transformOrigin="top left",this.contentPlane.style.transform=`translate(${this.context.getCanvasMargins().left}px, ${this.context.getCanvasMargins().top}px)`,this.addBackground(this.backgroundPlane);for(const t of this.model.getElements())new c(t,this.contentPlane).render();for(const t of this.model.getAllRulers()){const e=new d(t,this.context,this.rulerPlane);e.setZoom(this.context.getZoom()),e.render()}new l(this.intersectionPlane,this.model,this.context).render()}addBackground(t){const e=this.context.getCanvasMargins(),i=this.context.getCanvasWidth(),n=this.context.getCanvasHeight(),s=e.left+i+e.right,r=e.top+n+e.bottom,h=document.createElementNS(o,"rect");h.setAttribute("x","0"),h.setAttribute("y","0"),h.setAttribute("width",String(s)),h.setAttribute("height",String(r)),h.setAttribute("fill","darkgray");const a=document.createElementNS(o,"rect");a.setAttribute("x",String(e.left)),a.setAttribute("y",String(e.left)),a.setAttribute("width",String(i)),a.setAttribute("height",String(n)),a.setAttribute("fill","white"),t.appendChild(h),t.appendChild(a)}}class u{constructor(t,e,i){this.xAxisView=t,this.yAxisView=e,this.cornerView=i}render(){this.xAxisView.render(),this.yAxisView.render(),this.cornerView.render()}setRulerAreaSize(t,e,i){this.xAxisView.setRulerAreaSize(t,e,i),this.yAxisView.setRulerAreaSize(t,e,i),this.cornerView.setScreenSize(i,i)}setScroll(t,e){this.xAxisView.setScroll(t),this.yAxisView.setScroll(e)}}class m{constructor(t){this.model=t,this.zoom=1,this.canvasMarginTop=400,this.canvasMarginRight=400,this.canvasMarginBottom=400,this.canvasMarginLeft=400,this.renderCallback=()=>{},this.pushEventCallback=()=>{},this.pointPicker={enabled:!1,enable:()=>{console.log("ctx.pointPicker.enable"),this.pointPicker.enabled=!0,this.requestRender()},disable:()=>{console.log("ctx.pointPicker.disable"),this.pointPicker.enabled=!1,this.requestRender()},isSnap:!0,toggleSnap:()=>{console.log("ctx.pointPicker.toggleSnap -> ",!this.pointPicker.isSnap),this.pointPicker.isSnap=!this.pointPicker.isSnap,this.requestRender()}}}setRenderCallback(t){this.renderCallback=t}requestRender(){this.renderCallback()}setPushEventCallback(t){this.pushEventCallback=t}pushEvent(t){this.pushEventCallback(t)}getZoom(){return this.zoom}setZoom(t){this.zoom=t}resetZoom(){this.setZoom(1)}getCanvasMargins(){return{top:this.canvasMarginTop,right:this.canvasMarginRight,bottom:this.canvasMarginBottom,left:this.canvasMarginLeft}}getCanvasWidth(){return this.model.getWidth()}getCanvasHeight(){return this.model.getHeight()}getSvgWidth(){return(this.canvasMarginLeft+this.getCanvasWidth()+this.canvasMarginRight)*this.zoom}getSvgHeight(){return(this.canvasMarginTop+this.getCanvasHeight()+this.canvasMarginBottom)*this.zoom}}class p{constructor(){this.stage="start"}getMode(){return"insert-rect"}enter(t){this.ctx=t,this.ctx.env.enableIntersectionPicker(!0)}exit(){this.ctx.env.enableIntersectionPicker(!1)}push(e){if(console.log("InsertRectState push:",e),console.log("stage:",this.stage),"cancel"==e.type)return this.exit(),void this.ctx.emitEvent({type:"cancel"});if("pointSelected"==e.type)if("start"===this.stage)this.startPoint=e.point,this.stage="end";else{const i=new t("__Rect",this.startPoint,e.point);this.ctx.env.addElement(i),this.exit(),this.ctx.emitEvent({type:"complete"})}}}class v{constructor(t){this.model=t}serialize(){const t=document.createElementNS(o,"svg");this.model.getWidth()&&t.setAttribute("width",String(this.model.getWidth())),this.model.getHeight()&&t.setAttribute("height",String(this.model.getHeight()));for(const e of this.model.getElements()){const{x:i,y:n,width:s,height:r}=e.getBBox(),h=document.createElementNS(o,"rect");h.setAttribute("x",String(i)),h.setAttribute("y",String(n)),h.setAttribute("width",String(s)),h.setAttribute("height",String(r)),h.setAttribute("fill","lightgray"),t.appendChild(h)}return(new XMLSerializer).serializeToString(t)}}class f{constructor(t,e,i,n){this.container=t,this.model=e,this.context=i,this.controller=n}render(){for(;this.container.firstChild;)this.container.removeChild(this.container.firstChild);const t=document.createElement("button");this.container.appendChild(t),t.innerText="Zoom Up",t.addEventListener("click",(t=>{this.context.setZoom(this.context.getZoom()+.1),this.context.requestRender()}));const e=document.createElement("button");this.container.appendChild(e),e.innerText="Zoom Reset",e.addEventListener("click",(t=>{this.context.resetZoom(),this.context.requestRender()}));const i=document.createElement("button");this.container.appendChild(i),i.innerText="Zoom Down",i.addEventListener("click",(t=>{this.context.setZoom(this.context.getZoom()-.1),this.context.requestRender()}));const n=document.createElement("button");n.innerText="Cancel",n.addEventListener("click",(t=>{this.controller.push({type:"cancel"})})),this.container.appendChild(n);const s=document.createElement("button");s.innerText="Add Rect",s.addEventListener("click",(t=>{this.controller.enter(new p)})),this.container.appendChild(s),document.createElement("button").innerText="Select Rect";const r=document.createElement("button");r.innerText="Toggle Snap",r.addEventListener("click",(t=>{this.context.pointPicker.toggleSnap()})),this.container.appendChild(r);const o=document.createElement("button");o.innerText="Export SVG",o.addEventListener("click",(t=>{const e=new v(this.model).serialize(),i=new Blob([e],{type:"image/svg+xml"}),n=URL.createObjectURL(i),s=document.createElement("a");s.href=n,s.download="out.svg",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n)})),this.container.appendChild(o)}}class x{constructor(t,e,i){this.ruler=t,this.context=e,this.root=i,this.dom=null,this.baseStrokeWidth=10,this.svgStrokeWidth=10}setZoom(t){this.svgStrokeWidth=this.baseStrokeWidth/t,this.render()}render(){const t=this.ruler.getPosition();this.dom||(this.dom=document.createElementNS(o,"line"),this.root.appendChild(this.dom),this.ruler instanceof e&&this.dom.addEventListener("mousedown",(t=>{var e;this.onStartDragCallback,null===(e=this.onStartDragCallback)||void 0===e||e.call(this,this.ruler,t)}))),"horizontal"===this.ruler.direction?(this.dom.setAttribute("x1","0"),this.dom.setAttribute("y1",String(t+this.context.getCanvasMargins().top)),this.dom.setAttribute("x2",String(this.context.getCanvasMargins().left+this.context.getCanvasWidth()+this.context.getCanvasMargins().right)),this.dom.setAttribute("y2",String(t+this.context.getCanvasMargins().top)),this.dom.setAttribute("stroke","#00FF00")):(this.dom.setAttribute("x1",String(t+this.context.getCanvasMargins().left)),this.dom.setAttribute("y1","0"),this.dom.setAttribute("x2",String(t+this.context.getCanvasMargins().left)),this.dom.setAttribute("y2",String(this.context.getCanvasMargins().top+this.context.getCanvasHeight()+this.context.getCanvasMargins().bottom)),this.dom.setAttribute("stroke","#FF0000")),this.dom.setAttribute("stroke-width",String(this.svgStrokeWidth))}onStartDrag(t){this.onStartDragCallback=t}}class S{constructor(t,e,i){this.container=t,this.model=e,this.context=i,this.draggingRuler=null,this.dragStartPoint=null,this.animationFrameId=null,this.svgRoot=document.createElementNS(o,"svg"),this.container.appendChild(this.svgRoot),this.drawingPlane=document.createElementNS(o,"g"),this.svgRoot.appendChild(this.drawingPlane),this.attachEventListeners()}static createAndAttach(t,e,i){const n=document.createElement("div");return n.setAttribute("id","xAxisRulerAreaContainer"),n.style.display="inline-block",n.style.overflow="hidden",t.appendChild(n),new S(n,e,i)}setRulerAreaSize(t,e,i){this.container.style.width=String(t),this.container.style.height=String(i)}attachEventListeners(){this.container.addEventListener("mousemove",(t=>{this.onMouseMove(t)})),this.container.addEventListener("mouseup",(t=>{this.onMouseUp(t)}))}handleStartDrag(t,e){e.preventDefault(),this.draggingRuler=t,this.dragStartPoint=h(this.drawingPlane,e.clientX,e.clientY)}onMouseMove(t){if(!this.draggingRuler)return;const e=h(this.drawingPlane,t.clientX,t.clientY).x-this.dragStartPoint.x;this.draggingRuler.applyPreviewOffset(e),this.requestRender()}onMouseUp(t){this.draggingRuler&&(this.draggingRuler.commitPreview(),this.draggingRuler=null,this.cancelRenderLoop(),this.context.requestRender())}render(){for(this.svgRoot.setAttribute("width",String(this.context.getSvgWidth()+100)),this.svgRoot.setAttribute("height",String(this.container.clientHeight)),this.drawingPlane.style.transformOrigin="top left",this.drawingPlane.style.transform=`scale(${String(this.context.getZoom())}, 1.0)`;this.drawingPlane.firstChild;)this.drawingPlane.removeChild(this.drawingPlane.firstChild);for(const t of this.model.getAllRulers().filter((t=>"vertical"===t.direction))){const e=new x(t,this.context,this.drawingPlane);e.setZoom(this.context.getZoom()),e.onStartDrag(((t,e)=>this.handleStartDrag(t,e))),e.render()}}setScroll(t){this.container.scrollLeft=t}requestRender(){null===this.animationFrameId&&(this.animationFrameId=requestAnimationFrame((()=>{this.animationFrameId=null,this.context.requestRender()})))}cancelRenderLoop(){null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}}class b{constructor(t,e,i){this.container=t,this.model=e,this.context=i,this.draggingRuler=null,this.dragStartPoint=null,this.animationFrameId=null,this.svgRoot=document.createElementNS(o,"svg"),this.container.appendChild(this.svgRoot),this.drawingPlane=document.createElementNS(o,"g"),this.svgRoot.appendChild(this.drawingPlane),this.attachEventListeners()}static createAndAttach(t,e,i){const n=document.createElement("div");return n.setAttribute("id","yAxisRulerAreaContainer"),n.style.display="inline-block",n.style.overflow="hidden",t.appendChild(n),new b(n,e,i)}setRulerAreaSize(t,e,i){this.container.style.width=String(i),this.container.style.height=String(e)}attachEventListeners(){this.container.addEventListener("mousemove",(t=>{this.onMouseMove(t)})),this.container.addEventListener("mouseup",(t=>{this.onMouseUp(t)}))}handleStartDrag(t,e){e.preventDefault(),this.draggingRuler=t,this.dragStartPoint=h(this.drawingPlane,e.clientX,e.clientY)}onMouseMove(t){if(!this.draggingRuler)return;const e=h(this.drawingPlane,t.clientX,t.clientY).y-this.dragStartPoint.y;this.draggingRuler.applyPreviewOffset(e),this.requestRender()}onMouseUp(t){this.draggingRuler&&(this.draggingRuler.commitPreview(),this.draggingRuler=null,this.cancelRenderLoop(),this.context.requestRender())}render(){for(this.svgRoot.setAttribute("width",String(this.container.clientWidth)),this.svgRoot.setAttribute("height",String(this.context.getSvgWidth()+100)),this.drawingPlane.style.transformOrigin="top left",this.drawingPlane.style.transform=`scale(1.0, ${String(this.context.getZoom())})`;this.drawingPlane.firstChild;)this.drawingPlane.removeChild(this.drawingPlane.firstChild);for(const t of this.model.getAllRulers().filter((t=>"horizontal"===t.direction))){const e=new x(t,this.context,this.drawingPlane);e.setZoom(this.context.getZoom()),e.onStartDrag(((t,e)=>this.handleStartDrag(t,e))),e.render()}}setScroll(t){this.container.scrollTop=t}requestRender(){null===this.animationFrameId&&(this.animationFrameId=requestAnimationFrame((()=>{this.animationFrameId=null,this.context.requestRender()})))}cancelRenderLoop(){null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}}class w{constructor(){}getMode(){return"idle"}push(){}}class A{constructor(t){var e,i;this.context={env:t,emitEvent:t=>{this.handleState(t)}},this.childState=new w,null===(i=(e=this.childState).enter)||void 0===i||i.call(e,this.context)}getMode(){return this.childState.getMode()}handleState(t){var e,i,n,s;switch(t.type){case"complete":this.childState=new w,null===(i=(e=this.childState).enter)||void 0===i||i.call(e,this.context);break;case"cancel":this.childState=new w,null===(s=(n=this.childState).enter)||void 0===s||s.call(n,this.context)}}push(t){console.log("EditorInteractionController push:",t),this.childState.push(t)}enter(t){var e;return console.log(this.childState.getMode()),"idle"===this.getMode()&&(console.log("->",t.getMode()),this.childState=t,null===(e=t.enter)||void 0===e||e.call(t,this.context),!0)}cancel(){this.push({type:"cancel"})}}class C{constructor(t,e){for(this.container=t,this.model=e,this.context=new m(e),this.controller=new A({enableIntersectionPicker:t=>{console.log("EditorInteractionController.env.enableIntersectionPicker ->",t),t?(this.context.pointPicker.enable(),this.context.requestRender()):(this.context.pointPicker.disable(),this.context.requestRender())},requestRender:()=>{this.context.requestRender()},deleteSelectedElement:()=>{},addElement:t=>{this.model.addElement(t)}}),this.context.setPushEventCallback((t=>{this.controller.push(t)})),this.context.setRenderCallback((()=>{this.render()}));this.container.firstChild;)this.container.removeChild(this.container.firstChild);const i=document.createElement("div");i.style.display="inline-block",this.container.appendChild(i);const n=document.createElement("div"),s=document.createElement("div");i.appendChild(n),i.appendChild(s);const r=a.createAndAttach(n,this.model,this.context),o=S.createAndAttach(n,this.model,this.context),h=b.createAndAttach(s,this.model,this.context);this.editorPlaneView=g.createAndAttach(s,this.model,this.context),this.rulerAreaView=new u(o,h,r),this.editorPlaneView.setScrollListener(((t,e)=>{this.rulerAreaView.setScroll(t,e)}));const l=document.createElement("div");l.style.display="inline-block",this.container.appendChild(l),this.toolBarView=new f(l,this.model,this.context,this.controller),this.setScreenSize(700,500,50)}render(){this.editorPlaneView.render(),this.rulerAreaView.render(),this.toolBarView.render()}setupScrollSync(t,e,i){t.addEventListener("scroll",(()=>{i.scrollLeft=t.scrollLeft,e.scrollTop=t.scrollTop}))}setScreenSize(t,e,i){this.editorPlaneView.setScreenSize(t,e),this.rulerAreaView.setRulerAreaSize(t,e,i)}}const R=document.getElementById("editorScreen"),y=document.getElementById("xmlInput"),P=document.getElementById("loadButton");let E=null;P.addEventListener("click",(()=>{const t=y.value;try{const e=(new r).parse(t);E=new C(R,e),E.render()}catch(t){console.error("XML parsing/rendering failed:",t),alert("XML parsing/rendering failed.")}}))})();