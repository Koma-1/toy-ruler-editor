(()=>{"use strict";class t{constructor(t,e,i,s){this.id=t,this.start=e,this.end=i,this.graphicsAttributes=s}getBBox(){const t=this.start.getPosition(),e=this.end.getPosition();return t.x<e.x?t.x:e.x,t.y<e.y?t.y:e.y,{x:Math.min(t.x,e.x),y:Math.min(t.y,e.y),width:Math.abs(t.x-e.x),height:Math.abs(t.y-e.y)}}}class e{constructor(t,e,i,s){this.id=t,this.direction=e,this.baseRuler=i,this.offset=s,this.previewOffset=null}getPosition(){var t,e;return this.baseRuler?this.baseRuler.getPosition()+this.offset+(null!==(t=this.previewOffset)&&void 0!==t?t:0):this.offset+(null!==(e=this.previewOffset)&&void 0!==e?e:0)}applyPreviewOffset(t){this.previewOffset=t+this.offset>=0?t:-this.offset}commitPreview(){null!==this.previewOffset&&(this.offset+=this.previewOffset,this.previewOffset=null)}cancelPreview(){this.previewOffset=null}}class i{constructor(t,e){this.xRuler=t,this.yRuler=e}getPosition(){return{x:this.xRuler.getPosition(),y:this.yRuler.getPosition()}}}class s{constructor(t){this.pos=t}getPosition(){return this.pos}}class r{constructor(t=[],e=[]){this.rulers=new Map,this.elements=[];for(const e of t)this.rulers.set(e.id,e);this.elements=e}getRuler(t){return this.rulers.get(t)}getAllRulers(){return Array.from(this.rulers.values())}getElements(){return this.elements}addElement(t){this.elements.push(t)}removeElementById(t){this.elements=this.elements.filter((e=>e.id!==t))}}class n{constructor(){this.rulerMap=new Map,this.rectMap=new Map,this.rectList=[]}parse(t){if(t.length>5e4)throw"Input XML is too large.";const e=(new DOMParser).parseFromString(t,"application/xml");e.querySelector("parsererror")?console.log("parse error"):console.log(e.documentElement.nodeName);for(const t of Array.from(e.documentElement.children))switch(t.tagName){case"ruler":this.parseRulerTag(t);break;case"rect":this.parseRectTag(t)}return new r(Array.from(this.rulerMap.values()),this.rectList)}parseRulerTag(t){const e=t.getAttribute("id"),i=t.getAttribute("direction"),s=t.getAttribute("type");if(!e||!i||!s)throw"TODO";if(this.rulerMap.has(e))throw"TODO";if("horizontal"!=i&&"vertical"!=i)throw"TODO";if("chain"!=s)throw"TODO";this.parseChainedRulerTag(t,e,i)}parseChainedRulerTag(t,i,s){const r=t.getAttribute("offsetFrom"),n=t.getAttribute("offset");if(!n)throw"TODO";const o=Number(n);if(Number.isNaN(o))throw"TODO";if(r){const t=this.rulerMap.get(r);if(!t)throw"TODO";if(t.direction!=s)throw"TODO";this.rulerMap.set(i,new e(i,s,t,o))}else this.rulerMap.set(i,new e(i,s,null,o))}parseRectTag(e){const r=e.getAttribute("id");if(!r)throw"TODO";const n=e.getAttribute("startXRuler"),o=e.getAttribute("startYRuler"),h=e.getAttribute("startX"),a=e.getAttribute("startY");let l=null;if(n&&o&&!h&&!a){const t=this.rulerMap.get(n),e=this.rulerMap.get(o);if(!t||!e)throw"TODO";if("vertical"!=t.direction||"horizontal"!=e.direction)throw"TODO";l=new i(t,e)}else{if(n||o||!h||!a)throw"TODO";{const t=Number(h),e=Number(a);if(Number.isNaN(t)||Number.isNaN(e))throw"TODO";l=new s({x:t,y:e})}}if(!l)throw"TODO";const c=e.getAttribute("endXRuler"),d=e.getAttribute("endYRuler"),g=e.getAttribute("endX"),u=e.getAttribute("endY");let m=null;if(c&&d&&!g&&!u){const t=this.rulerMap.get(c),e=this.rulerMap.get(d);if(!t||!e)throw"TODO";if("vertical"!=t.direction||"horizontal"!=e.direction)throw"TODO";m=new i(t,e)}else{if(c||d||!g||!u)throw"TODO";{const t=Number(g),e=Number(u);if(Number.isNaN(t)||Number.isNaN(e))throw"TODO";m=new s({x:t,y:e})}}if(!m)throw"TODO";const v=new t(r,l,m);this.rectList.push(v),this.rectMap.set(r,v)}}const o="http://www.w3.org/2000/svg";function h(t,e,i){return new DOMPoint(e,i).matrixTransform(t.getScreenCTM().inverse())}class a{constructor(t,e){this.container=t,this.model=e,this.svgRoot=document.createElementNS(o,"svg"),this.container.appendChild(this.svgRoot)}setScreenSize(t,e){this.container.style.width=String(t),this.container.style.height=String(e)}setEditorPlaneSize(t,e){this.svgRoot.setAttribute("width",String(t)),this.svgRoot.setAttribute("height",String(e))}setScroll(t){}setZoom(t){}render(){}}class l{constructor(t,e){this.model=t,this.root=e,this.dom=null}render(){this.dom||(this.dom=document.createElementNS(o,"rect"),this.root.appendChild(this.dom));const{x:t,y:e,width:i,height:s}=this.model.getBBox();this.dom.setAttribute("x",String(t)),this.dom.setAttribute("y",String(e)),this.dom.setAttribute("width",String(i)),this.dom.setAttribute("height",String(s)),this.dom.setAttribute("fill","lightgray")}}class c{constructor(t,e,i){this.ruler=t,this.context=e,this.root=i,this.dom=null,this.baseStrokeWidth=1,this.svgStrokeWidth=1}setZoom(t){this.svgStrokeWidth=this.baseStrokeWidth/t,this.render()}render(){const t=this.ruler.getPosition();this.dom||(this.dom=document.createElementNS(o,"line"),this.root.appendChild(this.dom)),"horizontal"===this.ruler.direction?(this.dom.setAttribute("x1","0"),this.dom.setAttribute("y1",String(t+this.context.getCanvasMargins().top)),this.dom.setAttribute("x2",String(this.context.getCanvasMargins().left+this.context.getCanvasWidth()+this.context.getCanvasMargins().right)),this.dom.setAttribute("y2",String(t+this.context.getCanvasMargins().top)),this.dom.setAttribute("stroke","#00FF00")):(this.dom.setAttribute("x1",String(t+this.context.getCanvasMargins().left)),this.dom.setAttribute("y1","0"),this.dom.setAttribute("x2",String(t+this.context.getCanvasMargins().left)),this.dom.setAttribute("y2",String(this.context.getCanvasMargins().top+this.context.getCanvasHeight()+this.context.getCanvasMargins().bottom)),this.dom.setAttribute("stroke","#FF0000")),this.dom.setAttribute("stroke-width",String(this.svgStrokeWidth))}}class d{constructor(t,e,i){this.ruler=t,this.context=e,this.root=i,this.dom=null,this.baseStrokeWidth=5,this.svgStrokeWidth=5}setZoom(t){this.svgStrokeWidth=this.baseStrokeWidth/t,this.render()}render(){const t=this.ruler.getPosition();this.dom||(this.dom=document.createElementNS(o,"line"),this.root.appendChild(this.dom),this.ruler instanceof e&&this.dom.addEventListener("mousedown",(t=>{var e;this.onStartDragCallback,null===(e=this.onStartDragCallback)||void 0===e||e.call(this,this.ruler,t)}))),"horizontal"===this.ruler.direction?(this.dom.setAttribute("x1","0"),this.dom.setAttribute("y1",String(t+this.context.getCanvasMargins().top)),this.dom.setAttribute("x2",String(this.context.getCanvasMargins().left+this.context.getCanvasWidth()+this.context.getCanvasMargins().right)),this.dom.setAttribute("y2",String(t+this.context.getCanvasMargins().top)),this.dom.setAttribute("stroke","#00FF00")):(this.dom.setAttribute("x1",String(t+this.context.getCanvasMargins().left)),this.dom.setAttribute("y1","0"),this.dom.setAttribute("x2",String(t+this.context.getCanvasMargins().left)),this.dom.setAttribute("y2",String(this.context.getCanvasMargins().top+this.context.getCanvasHeight()+this.context.getCanvasMargins().bottom)),this.dom.setAttribute("stroke","#FF0000")),this.dom.setAttribute("stroke-width",String(this.svgStrokeWidth))}onStartDrag(t){this.onStartDragCallback=t}}class g{constructor(t,e,i){this.container=t,this.model=e,this.context=i,this.svgRoot=document.createElementNS(o,"svg"),this.container.appendChild(this.svgRoot),this.drawingGroup=document.createElementNS(o,"g"),this.svgRoot.appendChild(this.drawingGroup),this.backgroundPlane=document.createElementNS(o,"g"),this.contentPlane=document.createElementNS(o,"g"),this.rulerPlane=document.createElementNS(o,"g"),this.drawingGroup.appendChild(this.backgroundPlane),this.drawingGroup.appendChild(this.contentPlane),this.drawingGroup.appendChild(this.rulerPlane)}setScreenSize(t,e){this.container.style.width=String(t),this.container.style.height=String(e)}render(){for(this.svgRoot.setAttribute("width",String(this.context.getSvgWidth())),this.svgRoot.setAttribute("height",String(this.context.getSvgHeight())),this.drawingGroup.style.transformOrigin="top left",this.drawingGroup.style.transform=`scale(${String(this.context.getZoom())})`;this.backgroundPlane.firstChild;)this.backgroundPlane.removeChild(this.backgroundPlane.firstChild);for(;this.contentPlane.firstChild;)this.contentPlane.removeChild(this.contentPlane.firstChild);for(;this.rulerPlane.firstChild;)this.rulerPlane.removeChild(this.rulerPlane.firstChild);this.contentPlane.style.transformOrigin="top left",this.contentPlane.style.transform=`translate(${this.context.getCanvasMargins().left}px, ${this.context.getCanvasMargins().top}px)`,this.addBackground(this.backgroundPlane);for(const t of this.model.getElements())new l(t,this.contentPlane).render();for(const t of this.model.getAllRulers()){const e=new c(t,this.context,this.rulerPlane);e.setZoom(this.context.getZoom()),e.render()}}addBackground(t){const e=this.context.getCanvasMargins(),i=this.context.getCanvasWidth(),s=this.context.getCanvasHeight(),r=e.left+i+e.right,n=e.top+s+e.bottom,h=document.createElementNS(o,"rect");h.setAttribute("x","0"),h.setAttribute("y","0"),h.setAttribute("width",String(r)),h.setAttribute("height",String(n)),h.setAttribute("fill","darkgray");const a=document.createElementNS(o,"rect");a.setAttribute("x",String(e.left)),a.setAttribute("y",String(e.left)),a.setAttribute("width",String(i)),a.setAttribute("height",String(s)),a.setAttribute("fill","white"),t.appendChild(h),t.appendChild(a)}}class u{constructor(t,e,i,s,r){this.hContainer=t,this.vContainer=e,this.model=i,this.context=s,this.requestRenderCallback=r,this.draggingRuler=null,this.dragStartPoint=null,this.animationFrameId=null,this.hSvgRoot=document.createElementNS(o,"svg"),this.vSvgRoot=document.createElementNS(o,"svg"),this.hContainer.appendChild(this.hSvgRoot),this.vContainer.appendChild(this.vSvgRoot),this.hDrawingPlane=document.createElementNS(o,"g"),this.vDrawingPlane=document.createElementNS(o,"g"),this.hSvgRoot.appendChild(this.hDrawingPlane),this.vSvgRoot.appendChild(this.vDrawingPlane),this.attachEventListeners()}setRulerAreaSize(t,e,i){this.hContainer.style.width=String(i),this.hContainer.style.height=String(e),this.vContainer.style.width=String(t),this.vContainer.style.height=String(i)}attachEventListeners(){this.vContainer.addEventListener("mousemove",(t=>{this.onMouseMove(t)})),this.hContainer.addEventListener("mousemove",(t=>{this.onMouseMove(t)})),this.vContainer.addEventListener("mouseup",(t=>{this.onMouseUp(t)})),this.hContainer.addEventListener("mouseup",(t=>{this.onMouseUp(t)}))}handleStartDrag(t,e){switch(e.preventDefault(),this.draggingRuler=t,t.direction){case"horizontal":this.dragStartPoint=h(this.hDrawingPlane,e.clientX,e.clientY);break;case"vertical":this.dragStartPoint=h(this.vDrawingPlane,e.clientX,e.clientY)}}onMouseMove(t){if(!this.draggingRuler)return;const e=h("horizontal"===this.draggingRuler.direction?this.hDrawingPlane:this.vDrawingPlane,t.clientX,t.clientY),i="horizontal"===this.draggingRuler.direction?e.y-this.dragStartPoint.y:e.x-this.dragStartPoint.x;this.draggingRuler.applyPreviewOffset(i),this.requestRender()}onMouseUp(t){this.draggingRuler&&(this.draggingRuler.commitPreview(),this.draggingRuler=null,this.cancelRenderLoop(),this.requestRenderCallback())}render(){for(this.vSvgRoot.setAttribute("width",String(this.context.getSvgWidth()+100)),this.vSvgRoot.setAttribute("height",String(this.vContainer.clientHeight)),this.hSvgRoot.setAttribute("width",String(this.hContainer.clientWidth)),this.hSvgRoot.setAttribute("height",String(this.context.getSvgWidth()+100)),this.hDrawingPlane.style.transformOrigin="top left",this.vDrawingPlane.style.transformOrigin="top left",this.hDrawingPlane.style.transform=`scale(1.0, ${String(this.context.getZoom())})`,this.vDrawingPlane.style.transform=`scale(${String(this.context.getZoom())}, 1.0)`;this.hDrawingPlane.firstChild;)this.hDrawingPlane.removeChild(this.hDrawingPlane.firstChild);for(;this.vDrawingPlane.firstChild;)this.vDrawingPlane.removeChild(this.vDrawingPlane.firstChild);for(const t of this.model.getAllRulers())if("horizontal"==t.direction){const e=new d(t,this.context,this.hDrawingPlane);e.setZoom(this.context.getZoom()),e.onStartDrag(((t,e)=>this.handleStartDrag(t,e))),e.render()}else if("vertical"==t.direction){const e=new d(t,this.context,this.vDrawingPlane);e.setZoom(this.context.getZoom()),e.onStartDrag(((t,e)=>this.handleStartDrag(t,e))),e.render()}}requestRender(){null===this.animationFrameId&&(this.animationFrameId=requestAnimationFrame((()=>{this.animationFrameId=null,this.requestRenderCallback()})))}cancelRenderLoop(){null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}}class m{constructor(t,e,i){for(this.container=t,this.model=e,this.context=i;this.container.firstChild;)this.container.removeChild(this.container.firstChild);const[s,r,n,o]=this.createLayout();this.editorPlaneView=new g(s,this.model,this.context),this.rulerAreaView=new u(r,n,e,this.context,(()=>this.render())),this.cornerRulerAreaView=new a(o,this.model),this.setScreenSize(500,500,50)}createLayout(){const[t,e,i,s]=this.createContainers();this.setupScrollSync(t,e,i);const r=document.createElement("div");r.setAttribute("id","editorRow1"),r.appendChild(s),r.appendChild(i);const n=document.createElement("div");n.setAttribute("id","editorRow2"),n.appendChild(e),n.appendChild(t),this.container.appendChild(r),this.container.appendChild(n);const o=document.createElement("div"),h=document.createElement("button");o.appendChild(h),h.innerText="Zoom Up",h.addEventListener("click",(t=>{this.context.setZoom(this.context.getZoom()+.1),this.render()}));const a=document.createElement("button");o.appendChild(a),a.innerText="Zoom Reset",a.addEventListener("click",(t=>{this.context.resetZoom(),this.render()}));const l=document.createElement("button");return o.appendChild(l),l.innerText="Zoom Down",l.addEventListener("click",(t=>{this.context.setZoom(this.context.getZoom()-.1),this.render()})),this.container.appendChild(o),[t,e,i,s]}createContainers(){const t=document.createElement("div"),e=document.createElement("div"),i=document.createElement("div"),s=document.createElement("div");return t.setAttribute("id","editorPlaneContainer"),e.setAttribute("id","hRulerAreaContainer"),i.setAttribute("id","vRulerAreaContainer"),s.setAttribute("id","cornerRulerAreaContainer"),t.style.display="inline-block",e.style.display="inline-block",i.style.display="inline-block",s.style.display="inline-block",t.style.overflow="scroll",e.style.overflow="hidden",i.style.overflow="hidden",s.style.overflow="hidden",[t,e,i,s]}render(){this.editorPlaneView.render(),this.rulerAreaView.render(),this.cornerRulerAreaView.render()}setupScrollSync(t,e,i){t.addEventListener("scroll",(()=>{i.scrollLeft=t.scrollLeft,e.scrollTop=t.scrollTop}))}setScreenSize(t,e,i){this.editorPlaneView.setScreenSize(t,e),this.rulerAreaView.setRulerAreaSize(t,e,i),this.cornerRulerAreaView.setScreenSize(i,i)}}class v{constructor(){this.zoom=1,this.canvasWidth=640,this.canvasHeight=480,this.canvasMarginTop=400,this.canvasMarginRight=400,this.canvasMarginBottom=400,this.canvasMarginLeft=400}getZoom(){return this.zoom}setZoom(t){this.zoom=t}resetZoom(){this.setZoom(1)}getCanvasMargins(){return{top:this.canvasMarginTop,right:this.canvasMarginRight,bottom:this.canvasMarginBottom,left:this.canvasMarginLeft}}getCanvasWidth(){return this.canvasWidth}getCanvasHeight(){return this.canvasHeight}setCanvasSize(t,e){this.canvasWidth=t,this.canvasHeight=e}getSvgWidth(){return(this.canvasMarginLeft+this.canvasWidth+this.canvasMarginRight)*this.zoom}getSvgHeight(){return(this.canvasMarginTop+this.canvasHeight+this.canvasMarginBottom)*this.zoom}}const p=document.getElementById("editorScreen"),f=document.getElementById("xmlInput"),S=document.getElementById("loadButton");let w=null;S.addEventListener("click",(()=>{const t=f.value;try{const e=(new n).parse(t),i=new v;w=new m(p,e,i),w.render()}catch(t){console.error("XML parsing/rendering failed:",t),alert("XML parsing/rendering failed.")}}))})();