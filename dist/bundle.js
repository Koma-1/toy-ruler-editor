(()=>{"use strict";class t{constructor(t,e,i,n){this.id=t,this.start=e,this.end=i,this.graphicsAttributes=n}getBBox(){const t=this.start.getPosition(),e=this.end.getPosition();return t.x<e.x?t.x:e.x,t.y<e.y?t.y:e.y,{x:Math.min(t.x,e.x),y:Math.min(t.y,e.y),width:Math.abs(t.x-e.x),height:Math.abs(t.y-e.y)}}}class e{constructor(t,e,i,n){this.id=t,this.direction=e,this.baseRuler=i,this.offset=n,this.previewOffset=null}getPosition(){var t,e;return this.baseRuler?this.baseRuler.getPosition()+this.offset+(null!==(t=this.previewOffset)&&void 0!==t?t:0):this.offset+(null!==(e=this.previewOffset)&&void 0!==e?e:0)}applyPreviewOffset(t){this.previewOffset=t+this.offset>=0?t:-this.offset}commitPreview(){null!==this.previewOffset&&(this.offset+=this.previewOffset,this.previewOffset=null)}cancelPreview(){this.previewOffset=null}}class i{constructor(t,e){this.xRuler=t,this.yRuler=e}getPosition(){return{x:this.xRuler.getPosition(),y:this.yRuler.getPosition()}}}class n{constructor(t){this.pos=t}getPosition(){return this.pos}}class s{constructor(){this.used=new Set,this.counter=new Map}generateId(t){for(;;){const e=this.inclement(t),i=t+String(e);if(!this.used.has(i))return i;if(e>1e5)throw"unsupported"}}inclement(t){let e=1;return this.counter.has(t)&&(e+=this.counter.get(t)),this.counter.set(t,e),e}reserveId(t){this.used.add(t)}releaseId(t){this.used.delete(t)}}class r{constructor(t,e,i=[],n=[]){this.width=t,this.height=e,this.rulers=new Map,this.elements=[],this.idRegistry=new s;for(const t of i)this.rulers.set(t.id,t);for(const t of n)this.addElement(t)}getRuler(t){return this.rulers.get(t)}getAllRulers(){return Array.from(this.rulers.values())}getAllIntersections(){let t=[];for(const e of this.getAllRulers().filter((t=>"vertical"===t.direction)))for(const i of this.getAllRulers().filter((t=>"horizontal"===t.direction)))t.push({xRuler:e,yRuler:i});return t}getElements(){return this.elements}getElement(t){for(const e of this.elements)if(e.id===t)return e;return null}addElement(t){""===t.id&&(t.id=this.idRegistry.generateId("rect")),this.idRegistry.reserveId(t.id),this.elements.push(t)}addRuler(t){""===t.id&&(t.id=this.idRegistry.generateId(t.direction)),this.idRegistry.reserveId(t.id),this.rulers.set(t.id,t)}removeElementById(t){this.idRegistry.releaseId(t),this.elements=this.elements.filter((e=>e.id!==t))}getWidth(){var t;return null!==(t=this.width)&&void 0!==t?t:0}getHeight(){var t;return null!==(t=this.height)&&void 0!==t?t:0}}class o{constructor(){this.rulerMap=new Map,this.rectMap=new Map,this.rectList=[]}parse(t){if(t.length>5e4)throw"Input XML is too large.";const e=(new DOMParser).parseFromString(t,"application/xml");e.querySelector("parsererror")&&console.log("parse error");for(const t of e.documentElement.attributes)if("width"===t.name){const e=Number(t.value);if(Number.isNaN(e))throw"nan";this.width=e}else if("height"===t.name){const e=Number(t.value);if(Number.isNaN(e))throw"nan";this.height=e}for(const t of Array.from(e.documentElement.children))switch(t.tagName){case"ruler":this.parseRulerTag(t);break;case"rect":this.parseRectTag(t)}return new r(this.width,this.height,Array.from(this.rulerMap.values()),this.rectList)}parseRulerTag(t){const e=t.getAttribute("id"),i=t.getAttribute("direction"),n=t.getAttribute("type");if(!e||!i||!n)throw"TODO";if(this.rulerMap.has(e))throw"TODO";if("horizontal"!=i&&"vertical"!=i)throw"TODO";if("chain"!=n)throw"TODO";this.parseChainedRulerTag(t,e,i)}parseChainedRulerTag(t,i,n){const s=t.getAttribute("offsetFrom"),r=t.getAttribute("offset");if(!r)throw"TODO";const o=Number(r);if(Number.isNaN(o))throw"TODO";if(s){const t=this.rulerMap.get(s);if(!t)throw"TODO";if(t.direction!=n)throw"TODO";this.rulerMap.set(i,new e(i,n,t,o))}else this.rulerMap.set(i,new e(i,n,null,o))}parseRectTag(e){const s=e.getAttribute("id");if(!s)throw"TODO";const r=e.getAttribute("startXRuler"),o=e.getAttribute("startYRuler"),l=e.getAttribute("startX"),a=e.getAttribute("startY");let h=null;if(r&&o&&!l&&!a){const t=this.rulerMap.get(r),e=this.rulerMap.get(o);if(!t||!e)throw"TODO";if("vertical"!=t.direction||"horizontal"!=e.direction)throw"TODO";h=new i(t,e)}else{if(r||o||!l||!a)throw"TODO";{const t=Number(l),e=Number(a);if(Number.isNaN(t)||Number.isNaN(e))throw"TODO";h=new n({x:t,y:e})}}if(!h)throw"TODO";const c=e.getAttribute("endXRuler"),d=e.getAttribute("endYRuler"),g=e.getAttribute("endX"),u=e.getAttribute("endY");let m=null;if(c&&d&&!g&&!u){const t=this.rulerMap.get(c),e=this.rulerMap.get(d);if(!t||!e)throw"TODO";if("vertical"!=t.direction||"horizontal"!=e.direction)throw"TODO";m=new i(t,e)}else{if(c||d||!g||!u)throw"TODO";{const t=Number(g),e=Number(u);if(Number.isNaN(t)||Number.isNaN(e))throw"TODO";m=new n({x:t,y:e})}}if(!m)throw"TODO";const p=new t(s,h,m);this.rectList.push(p),this.rectMap.set(s,p)}}const l="http://www.w3.org/2000/svg";function a(t,e,i){return new DOMPoint(e,i).matrixTransform(t.getScreenCTM().inverse())}class h{constructor(t,e,i){this.container=t,this.model=e,this.context=i,this.svgRoot=document.createElementNS(l,"svg"),this.container.appendChild(this.svgRoot)}static createAndAttach(t,e,i){const n=document.createElement("div");return n.setAttribute("id","cornersRulerAreaContainer"),n.style.display="inline-block",n.style.overflow="hidden",t.appendChild(n),new h(n,e,i)}setScreenSize(t,e){this.container.style.width=String(t),this.container.style.height=String(e)}setEditorPlaneSize(t,e){this.svgRoot.setAttribute("width",String(t)),this.svgRoot.setAttribute("height",String(e))}setScroll(t){}setZoom(t){}render(){}}class c{constructor(t,e,i){this.svgRoot=t,this.model=e,this.context=i,this.pointLayer=document.createElementNS("http://www.w3.org/2000/svg","g")}render(){for(;this.svgRoot.firstChild;)this.svgRoot.removeChild(this.svgRoot.firstChild);if(!this.context.pointPicker.enabled)return;const t=document.createElementNS(l,"rect");t.setAttribute("x","0"),t.setAttribute("y","0"),t.setAttribute("width",String(this.context.getSvgWidth())),t.setAttribute("height",String(this.context.getSvgHeight())),t.setAttribute("fill","transparent"),t.setAttribute("pointer-events","all"),this.svgRoot.appendChild(t),this.pointLayer=document.createElementNS(l,"g"),this.svgRoot.appendChild(this.pointLayer),t.addEventListener("mousemove",(t=>{const e=a(this.svgRoot,t.clientX,t.clientY);this.updateHoveredIntersections({x:e.x-this.context.getCanvasMargins().left,y:e.y-this.context.getCanvasMargins().top},this.pointLayer)}))}updateHoveredIntersections(t,e){for(;e.firstChild;)e.removeChild(e.firstChild);const s=this.context.getZoom(),r=10/s;if(this.context.pointPicker.isSnap){const n=this.model.getAllIntersections();let o=-1,a=Number.MAX_VALUE;for(const[e,i]of n.entries()){const n=Math.abs(t.x-i.xRuler.getPosition()),l=Math.abs(t.y-i.yRuler.getPosition());n*s<r&&l*s<r&&n*n+l*l<a&&(o=e,a=n*n+l*l)}if(-1!=o){const t=n[o],s=document.createElementNS(l,"circle");s.setAttribute("cx",String(t.xRuler.getPosition()+this.context.getCanvasMargins().left)),s.setAttribute("cy",String(t.yRuler.getPosition()+this.context.getCanvasMargins().top)),s.setAttribute("r",String(r)),s.setAttribute("fill","#FF00FF"),s.addEventListener("click",(e=>{this.context.pushEvent({type:"pointSelected",point:new i(t.xRuler,t.yRuler)})})),e.appendChild(s)}}else{const i=document.createElementNS(l,"circle");i.setAttribute("cx",String(t.x+this.context.getCanvasMargins().left)),i.setAttribute("cy",String(t.y+this.context.getCanvasMargins().top)),i.setAttribute("r",String(r)),i.setAttribute("fill","#FF00FF"),i.setAttribute("pointer-events","click"),i.addEventListener("click",(e=>{this.context.pushEvent({type:"pointSelected",point:new n({x:t.x,y:t.y})})})),i.addEventListener("mousemove",(t=>{const e=a(this.svgRoot,t.clientX,t.clientY);this.updateHoveredIntersections({x:e.x-this.context.getCanvasMargins().left,y:e.y-this.context.getCanvasMargins().top},this.pointLayer)})),e.appendChild(i)}}}class d{constructor(t,e,i){this.root=t,this.model=e,this.context=i,this.dom=null,this.abortController=new AbortController}render(){this.dom=document.createElementNS(l,"rect"),this.root.appendChild(this.dom),this.context.selectElement.enabled?this.dom.addEventListener("click",(t=>{this.context.pushEvent({type:"graphicsElementSelected",id:this.model.id})}),{signal:this.abortController.signal}):this.abortController.abort();const{x:t,y:e,width:i,height:n}=this.model.getBBox();this.dom.setAttribute("x",String(t)),this.dom.setAttribute("y",String(e)),this.dom.setAttribute("width",String(i)),this.dom.setAttribute("height",String(n)),this.dom.setAttribute("fill","lightgray")}}class g{constructor(t,e,i){this.ruler=t,this.context=e,this.root=i,this.dom=null,this.baseStrokeWidth=1,this.svgStrokeWidth=1}setZoom(t){this.svgStrokeWidth=this.baseStrokeWidth/t,this.render()}render(){const t=this.ruler.getPosition();this.dom||(this.dom=document.createElementNS(l,"line"),this.root.appendChild(this.dom)),"horizontal"===this.ruler.direction?(this.dom.setAttribute("x1","0"),this.dom.setAttribute("y1",String(t+this.context.getCanvasMargins().top)),this.dom.setAttribute("x2",String(this.context.getCanvasMargins().left+this.context.getCanvasWidth()+this.context.getCanvasMargins().right)),this.dom.setAttribute("y2",String(t+this.context.getCanvasMargins().top)),this.dom.setAttribute("stroke","#00FF00")):(this.dom.setAttribute("x1",String(t+this.context.getCanvasMargins().left)),this.dom.setAttribute("y1","0"),this.dom.setAttribute("x2",String(t+this.context.getCanvasMargins().left)),this.dom.setAttribute("y2",String(this.context.getCanvasMargins().top+this.context.getCanvasHeight()+this.context.getCanvasMargins().bottom)),this.dom.setAttribute("stroke","#FF0000")),this.dom.setAttribute("stroke-width",String(this.svgStrokeWidth))}}class u{constructor(t,e,i){this.container=t,this.model=e,this.context=i,this.strokeWidth=3}render(){const t=document.createElementNS("http://www.w3.org/2000/svg","rect");t.setAttribute("stroke","blue"),t.setAttribute("stroke-width",String(this.strokeWidth/this.context.getZoom())),t.setAttribute("fill","none"),t.setAttribute("stroke-dasharray",`${10/this.context.getZoom()} ${5/this.context.getZoom()}`);const{x:e,y:i,width:n,height:s}=this.model.getBBox();t.setAttribute("x",String(e)),t.setAttribute("y",String(i)),t.setAttribute("width",String(n)),t.setAttribute("height",String(s)),this.container.appendChild(t)}}class m{constructor(t,e,i){this.container=t,this.model=e,this.context=i,this.svgRoot=document.createElementNS(l,"svg"),this.container.appendChild(this.svgRoot),this.drawingGroup=document.createElementNS(l,"g"),this.svgRoot.appendChild(this.drawingGroup),this.backgroundPlane=document.createElementNS(l,"g"),this.contentPlane=document.createElementNS(l,"g"),this.rulerPlane=document.createElementNS(l,"g"),this.intersectionPlane=document.createElementNS(l,"g"),this.overlayPlane=document.createElementNS(l,"g"),this.drawingGroup.appendChild(this.backgroundPlane),this.drawingGroup.appendChild(this.contentPlane),this.drawingGroup.appendChild(this.rulerPlane),this.drawingGroup.appendChild(this.intersectionPlane),this.drawingGroup.appendChild(this.overlayPlane),this.container.addEventListener("scroll",(()=>{var t;null===(t=this.onScroll)||void 0===t||t.call(this,this.container.scrollLeft,this.container.scrollTop)}))}setScrollListener(t){this.onScroll=t}static createAndAttach(t,e,i){const n=document.createElement("div");return n.id="editorPlaneContainer",n.style.overflow="scroll",n.style.display="inline-block",t.appendChild(n),new m(n,e,i)}setScreenSize(t,e){this.container.style.width=String(t),this.container.style.height=String(e)}render(){for(this.svgRoot.setAttribute("width",String(this.context.getSvgWidth())),this.svgRoot.setAttribute("height",String(this.context.getSvgHeight())),this.drawingGroup.style.transformOrigin="top left",this.drawingGroup.style.transform=`scale(${String(this.context.getZoom())})`;this.backgroundPlane.firstChild;)this.backgroundPlane.removeChild(this.backgroundPlane.firstChild);for(;this.contentPlane.firstChild;)this.contentPlane.removeChild(this.contentPlane.firstChild);for(;this.rulerPlane.firstChild;)this.rulerPlane.removeChild(this.rulerPlane.firstChild);for(;this.overlayPlane.firstChild;)this.overlayPlane.removeChild(this.overlayPlane.firstChild);this.contentPlane.style.transformOrigin="top left",this.contentPlane.style.transform=`translate(${this.context.getCanvasMargins().left}px, ${this.context.getCanvasMargins().top}px)`,this.overlayPlane.style.transformOrigin="top left",this.overlayPlane.style.transform=`translate(${this.context.getCanvasMargins().left}px, ${this.context.getCanvasMargins().top}px)`,this.addBackground(this.backgroundPlane);for(const t of this.model.getElements())new d(this.contentPlane,t,this.context).render();for(const t of this.context.getSelectedIds()){console.log(t);const e=this.model.getElement(t);if(!e){console.log("not exists");break}new u(this.overlayPlane,e,this.context).render()}for(const t of this.model.getAllRulers()){const e=new g(t,this.context,this.rulerPlane);e.setZoom(this.context.getZoom()),e.render()}new c(this.intersectionPlane,this.model,this.context).render()}addBackground(t){const e=this.context.getCanvasMargins(),i=this.context.getCanvasWidth(),n=this.context.getCanvasHeight(),s=e.left+i+e.right,r=e.top+n+e.bottom,o=document.createElementNS(l,"rect");o.setAttribute("x","0"),o.setAttribute("y","0"),o.setAttribute("width",String(s)),o.setAttribute("height",String(r)),o.setAttribute("fill","darkgray");const a=document.createElementNS(l,"rect");a.setAttribute("x",String(e.left)),a.setAttribute("y",String(e.left)),a.setAttribute("width",String(i)),a.setAttribute("height",String(n)),a.setAttribute("fill","white"),t.appendChild(o),t.appendChild(a)}}class p{constructor(t,e,i){this.xAxisView=t,this.yAxisView=e,this.cornerView=i}render(){this.xAxisView.render(),this.yAxisView.render(),this.cornerView.render()}setRulerAreaSize(t,e,i){this.xAxisView.setRulerAreaSize(t,e,i),this.yAxisView.setRulerAreaSize(t,e,i),this.cornerView.setScreenSize(i,i)}setScroll(t,e){this.xAxisView.setScroll(t),this.yAxisView.setScroll(e)}}class v{constructor(t){this.model=t,this.zoom=1,this.canvasMarginTop=400,this.canvasMarginRight=400,this.canvasMarginBottom=400,this.canvasMarginLeft=400,this.renderCallback=()=>{},this.pushEventCallback=()=>{},this.getSelectedIdsCallback=()=>[],this.pointPicker={enabled:!1,enable:()=>{console.log("ctx.pointPicker.enable"),this.pointPicker.enabled=!0,this.requestRender()},disable:()=>{console.log("ctx.pointPicker.disable"),this.pointPicker.enabled=!1,this.requestRender()},isSnap:!0,toggleSnap:()=>{console.log("ctx.pointPicker.toggleSnap -> ",!this.pointPicker.isSnap),this.pointPicker.isSnap=!this.pointPicker.isSnap,this.requestRender()}},this.selectElement={enabled:!0,enable:()=>{console.log("ctx.selectElement.enable"),this.selectElement.enabled=!0,this.requestRender()},disable:()=>{console.log("ctx.selectElement.disable"),this.selectElement.enabled=!1,this.requestRender()}}}setRenderCallback(t){this.renderCallback=t}requestRender(){this.renderCallback()}setPushEventCallback(t){this.pushEventCallback=t}pushEvent(t){this.pushEventCallback(t)}setSelectedIdsCallback(t){this.getSelectedIdsCallback=t}getSelectedIds(){return this.getSelectedIdsCallback()}getZoom(){return this.zoom}setZoom(t){this.zoom=t}resetZoom(){this.setZoom(1)}getCanvasMargins(){return{top:this.canvasMarginTop,right:this.canvasMarginRight,bottom:this.canvasMarginBottom,left:this.canvasMarginLeft}}getCanvasWidth(){return this.model.getWidth()}getCanvasHeight(){return this.model.getHeight()}getSvgWidth(){return(this.canvasMarginLeft+this.getCanvasWidth()+this.canvasMarginRight)*this.zoom}getSvgHeight(){return(this.canvasMarginTop+this.getCanvasHeight()+this.canvasMarginBottom)*this.zoom}}class f{constructor(){this.stage="start"}getMode(){return"insert-rect"}enter(t){this.ctx=t,this.ctx.env.enableIntersectionPicker(!0)}exit(){this.ctx.env.enableIntersectionPicker(!1)}push(e){if(console.log("InsertRectState push:",e),console.log("stage:",this.stage),"cancel"==e.type)return this.exit(),void this.ctx.emitEvent({type:"cancel"});if("pointSelected"==e.type)if("start"===this.stage)this.startPoint=e.point,this.stage="end";else{const i=new t("",this.startPoint,e.point);this.ctx.env.addElement(i),this.exit(),this.ctx.emitEvent({type:"complete"})}}}class x{constructor(t){this.model=t}serialize(){const t=document.createElementNS(l,"svg");this.model.getWidth()&&t.setAttribute("width",String(this.model.getWidth())),this.model.getHeight()&&t.setAttribute("height",String(this.model.getHeight()));for(const e of this.model.getElements()){const{x:i,y:n,width:s,height:r}=e.getBBox(),o=document.createElementNS(l,"rect");o.setAttribute("x",String(i)),o.setAttribute("y",String(n)),o.setAttribute("width",String(s)),o.setAttribute("height",String(r)),o.setAttribute("fill","lightgray"),t.appendChild(o)}return(new XMLSerializer).serializeToString(t)}}class S{constructor(t,e,i,n){this.model=e,this.context=i,this.controller=n,this.container_container=t,this.container_container.style.verticalAlign="top",this.container=document.createElement("div"),this.container_container.appendChild(this.container),this.container.style.display="flex",this.container.style.flexDirection="column"}render(){for(;this.container.firstChild;)this.container.removeChild(this.container.firstChild);const t=document.createElement("button");this.container.appendChild(t),t.innerText="Zoom Up",t.addEventListener("click",(t=>{this.context.setZoom(this.context.getZoom()+.1),this.context.requestRender()}));const e=document.createElement("button");this.container.appendChild(e),e.innerText="Zoom Reset",e.addEventListener("click",(t=>{this.context.resetZoom(),this.context.requestRender()}));const i=document.createElement("button");this.container.appendChild(i),i.innerText="Zoom Down",i.addEventListener("click",(t=>{this.context.setZoom(this.context.getZoom()-.1),this.context.requestRender()}));const n=document.createElement("button");n.innerText="Cancel",n.addEventListener("click",(t=>{this.controller.push({type:"cancel"})})),this.container.appendChild(n);const s=document.createElement("button");s.innerText="Add Rect",s.addEventListener("click",(t=>{this.controller.enter(new f)})),this.container.appendChild(s),document.createElement("button").innerText="Select Rect";const r=document.createElement("button");r.innerText="Toggle Snap",r.addEventListener("click",(t=>{this.context.pointPicker.toggleSnap()})),this.container.appendChild(r);const o=document.createElement("button");o.innerText="Remove",o.addEventListener("click",(t=>{this.controller.push({type:"command",command:"remove"})})),this.container.appendChild(o);const l=document.createElement("button");l.innerText="Export SVG",l.addEventListener("click",(t=>{const e=new x(this.model).serialize(),i=new Blob([e],{type:"image/svg+xml"}),n=URL.createObjectURL(i),s=document.createElement("a");s.href=n,s.download="out.svg",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n)})),this.container.appendChild(l)}}class b{constructor(t,e,i){this.ruler=t,this.context=e,this.root=i,this.dom=null,this.baseStrokeWidth=10,this.svgStrokeWidth=10}setZoom(t){this.svgStrokeWidth=this.baseStrokeWidth/t,this.render()}render(){const t=this.ruler.getPosition();this.dom||(this.dom=document.createElementNS(l,"line"),this.root.appendChild(this.dom),this.ruler instanceof e&&this.dom.addEventListener("mousedown",(t=>{var e;this.onStartDragCallback,null===(e=this.onStartDragCallback)||void 0===e||e.call(this,this.ruler,t)}))),"horizontal"===this.ruler.direction?(this.dom.setAttribute("x1","0"),this.dom.setAttribute("y1",String(t+this.context.getCanvasMargins().top)),this.dom.setAttribute("x2",String(this.context.getCanvasMargins().left+this.context.getCanvasWidth()+this.context.getCanvasMargins().right)),this.dom.setAttribute("y2",String(t+this.context.getCanvasMargins().top)),this.dom.setAttribute("stroke","#00FF00")):(this.dom.setAttribute("x1",String(t+this.context.getCanvasMargins().left)),this.dom.setAttribute("y1","0"),this.dom.setAttribute("x2",String(t+this.context.getCanvasMargins().left)),this.dom.setAttribute("y2",String(this.context.getCanvasMargins().top+this.context.getCanvasHeight()+this.context.getCanvasMargins().bottom)),this.dom.setAttribute("stroke","#FF0000")),this.dom.setAttribute("stroke-width",String(this.svgStrokeWidth))}onStartDrag(t){this.onStartDragCallback=t}}class w{constructor(t,e,i){this.container=t,this.model=e,this.context=i,this.draggingRuler=null,this.dragStartPoint=null,this.animationFrameId=null,this.svgRoot=document.createElementNS(l,"svg"),this.container.appendChild(this.svgRoot),this.drawingPlane=document.createElementNS(l,"g"),this.svgRoot.appendChild(this.drawingPlane),this.attachEventListeners()}static createAndAttach(t,e,i){const n=document.createElement("div");return n.setAttribute("id","xAxisRulerAreaContainer"),n.style.display="inline-block",n.style.overflow="hidden",t.appendChild(n),new w(n,e,i)}setRulerAreaSize(t,e,i){this.container.style.width=String(t),this.container.style.height=String(i)}attachEventListeners(){this.container.addEventListener("mousemove",(t=>{this.onMouseMove(t)})),this.container.addEventListener("mouseup",(t=>{this.onMouseUp(t)}))}handleStartDrag(t,e){e.preventDefault(),this.draggingRuler=t,this.dragStartPoint=a(this.drawingPlane,e.clientX,e.clientY)}onMouseMove(t){if(!this.draggingRuler)return;const e=a(this.drawingPlane,t.clientX,t.clientY).x-this.dragStartPoint.x;this.draggingRuler.applyPreviewOffset(e),this.requestRender()}onMouseUp(t){this.draggingRuler&&(this.draggingRuler.commitPreview(),this.draggingRuler=null,this.cancelRenderLoop(),this.context.requestRender())}render(){for(this.svgRoot.setAttribute("width",String(this.context.getSvgWidth()+100)),this.svgRoot.setAttribute("height",String(this.container.clientHeight)),this.drawingPlane.style.transformOrigin="top left",this.drawingPlane.style.transform=`scale(${String(this.context.getZoom())}, 1.0)`;this.drawingPlane.firstChild;)this.drawingPlane.removeChild(this.drawingPlane.firstChild);for(const t of this.model.getAllRulers().filter((t=>"vertical"===t.direction))){const e=new b(t,this.context,this.drawingPlane);e.setZoom(this.context.getZoom()),e.onStartDrag(((t,e)=>this.handleStartDrag(t,e))),e.render()}}setScroll(t){this.container.scrollLeft=t}requestRender(){null===this.animationFrameId&&(this.animationFrameId=requestAnimationFrame((()=>{this.animationFrameId=null,this.context.requestRender()})))}cancelRenderLoop(){null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}}class y{constructor(t,e,i){this.container=t,this.model=e,this.context=i,this.draggingRuler=null,this.dragStartPoint=null,this.animationFrameId=null,this.svgRoot=document.createElementNS(l,"svg"),this.container.appendChild(this.svgRoot),this.drawingPlane=document.createElementNS(l,"g"),this.svgRoot.appendChild(this.drawingPlane),this.attachEventListeners()}static createAndAttach(t,e,i){const n=document.createElement("div");return n.setAttribute("id","yAxisRulerAreaContainer"),n.style.display="inline-block",n.style.overflow="hidden",t.appendChild(n),new y(n,e,i)}setRulerAreaSize(t,e,i){this.container.style.width=String(i),this.container.style.height=String(e)}attachEventListeners(){this.container.addEventListener("mousemove",(t=>{this.onMouseMove(t)})),this.container.addEventListener("mouseup",(t=>{this.onMouseUp(t)}))}handleStartDrag(t,e){e.preventDefault(),this.draggingRuler=t,this.dragStartPoint=a(this.drawingPlane,e.clientX,e.clientY)}onMouseMove(t){if(!this.draggingRuler)return;const e=a(this.drawingPlane,t.clientX,t.clientY).y-this.dragStartPoint.y;this.draggingRuler.applyPreviewOffset(e),this.requestRender()}onMouseUp(t){this.draggingRuler&&(this.draggingRuler.commitPreview(),this.draggingRuler=null,this.cancelRenderLoop(),this.context.requestRender())}render(){for(this.svgRoot.setAttribute("width",String(this.container.clientWidth)),this.svgRoot.setAttribute("height",String(this.context.getSvgWidth()+100)),this.drawingPlane.style.transformOrigin="top left",this.drawingPlane.style.transform=`scale(1.0, ${String(this.context.getZoom())})`;this.drawingPlane.firstChild;)this.drawingPlane.removeChild(this.drawingPlane.firstChild);for(const t of this.model.getAllRulers().filter((t=>"horizontal"===t.direction))){const e=new b(t,this.context,this.drawingPlane);e.setZoom(this.context.getZoom()),e.onStartDrag(((t,e)=>this.handleStartDrag(t,e))),e.render()}}setScroll(t){this.container.scrollTop=t}requestRender(){null===this.animationFrameId&&(this.animationFrameId=requestAnimationFrame((()=>{this.animationFrameId=null,this.context.requestRender()})))}cancelRenderLoop(){null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}}class A{constructor(){}getMode(){return"edit-element"}enter(t){this.ctx=t,this.ctx.env.enableElementSelection(!0)}exit(){this.ctx.selection.clear(),this.ctx.env.enableElementSelection(!1)}push(t){if(console.log("EditElementState"),"cancel"==t.type)return this.exit(),void this.ctx.emitEvent({type:"cancel"});if("graphicsElementSelected"==t.type)this.ctx.selection.has(t.id)?this.ctx.selection.delete(t.id):this.ctx.selection.add(t.id);else{if("command"!=t.type)return;if("remove"==t.command){for(const t of this.ctx.selection.entries())this.ctx.env.removeElement(t);this.ctx.selection.clear()}}this.ctx.env.requestRender()}}class C{constructor(t){var e,i;this.selectedElements=new Set,this.context={env:t,emitEvent:t=>{this.handleState(t)},selection:{add:t=>{this.addSelectedElement(t)},delete:t=>{this.deleteSelectedElement(t)},clear:()=>{this.resetSelectedElement()},has:t=>this.hasSelectedElement(t),entries:()=>this.getAllSelectedElement()}},this.childState=new A,null===(i=(e=this.childState).enter)||void 0===i||i.call(e,this.context)}getMode(){return this.childState.getMode()}handleState(t){var e,i,n,s;switch(t.type){case"complete":this.childState=new A,null===(i=(e=this.childState).enter)||void 0===i||i.call(e,this.context);break;case"cancel":this.childState=new A,null===(s=(n=this.childState).enter)||void 0===s||s.call(n,this.context)}}push(t){console.log("EditorInteractionController push:",t),this.childState.push(t)}enter(t){var e;return console.log(this.childState.getMode()),this.childState.push({type:"cancel"}),console.log("->",t.getMode()),this.childState=t,null===(e=t.enter)||void 0===e||e.call(t,this.context),!0}cancel(){this.push({type:"cancel"})}addSelectedElement(t){this.selectedElements.add(t)}deleteSelectedElement(t){this.selectedElements.delete(t)}resetSelectedElement(){this.selectedElements.clear()}hasSelectedElement(t){return this.selectedElements.has(t)}getAllSelectedElement(){return Array.from(this.selectedElements)}getSelectedIds(){return Array.from(this.selectedElements)}}class R{constructor(t,e){for(this.container=t,this.model=e,this.context=new v(e),this.controller=new C({enableIntersectionPicker:t=>{console.log("EditorInteractionController.env.enableIntersectionPicker ->",t),t?(this.context.pointPicker.enable(),this.context.requestRender()):(this.context.pointPicker.disable(),this.context.requestRender())},enableElementSelection:t=>{t?(this.context.selectElement.enable(),this.context.requestRender()):(this.context.selectElement.disable(),this.context.requestRender())},requestRender:()=>{this.context.requestRender()},removeElement:t=>{this.model.removeElementById(t)},addElement:t=>{this.model.addElement(t)}}),this.context.setPushEventCallback((t=>{this.controller.push(t)})),this.context.setSelectedIdsCallback((()=>(console.log("CALL getSelectedIdsCallback"),this.controller.getSelectedIds()))),this.context.setRenderCallback((()=>{this.render()}));this.container.firstChild;)this.container.removeChild(this.container.firstChild);const i=document.createElement("div");i.style.display="inline-block",this.container.appendChild(i);const n=document.createElement("div"),s=document.createElement("div");i.appendChild(n),i.appendChild(s);const r=h.createAndAttach(n,this.model,this.context),o=w.createAndAttach(n,this.model,this.context),l=y.createAndAttach(s,this.model,this.context);this.editorPlaneView=m.createAndAttach(s,this.model,this.context),this.rulerAreaView=new p(o,l,r),this.editorPlaneView.setScrollListener(((t,e)=>{this.rulerAreaView.setScroll(t,e)}));const a=document.createElement("div");a.style.display="inline-block",this.container.appendChild(a),this.toolBarView=new S(a,this.model,this.context,this.controller),this.setScreenSize(700,500,50)}render(){this.editorPlaneView.render(),this.rulerAreaView.render(),this.toolBarView.render()}setupScrollSync(t,e,i){t.addEventListener("scroll",(()=>{i.scrollLeft=t.scrollLeft,e.scrollTop=t.scrollTop}))}setScreenSize(t,e,i){this.editorPlaneView.setScreenSize(t,e),this.rulerAreaView.setRulerAreaSize(t,e,i)}}const E=document.getElementById("editorScreen"),P=document.getElementById("xmlInput"),k=document.getElementById("loadButton");P.value='<root width="500" height="500">\n  <ruler id="H0" direction="horizontal" type="chain" offset="0" />\n  <ruler id="H1" direction="horizontal" type="chain" offsetFrom="H0" offset="100" />\n  <ruler id="H2" direction="horizontal" type="chain" offsetFrom="H1" offset="50" />\n  <ruler id="H3" direction="horizontal" type="chain" offsetFrom="H2" offset="50" />\n  <ruler id="H4" direction="horizontal" type="chain" offsetFrom="H3" offset="50" />\n  <ruler id="V0" direction="vertical" type="chain" offset="0" />\n  <ruler id="V1" direction="vertical" type="chain" offsetFrom="V0" offset="150" />\n  <ruler id="V2" direction="vertical" type="chain" offsetFrom="V1" offset="80" />\n  <ruler id="V3" direction="vertical" type="chain" offsetFrom="V2" offset="20" />\n  <ruler id="V4" direction="vertical" type="chain" offsetFrom="V3" offset="30" />\n  <ruler id="V5" direction="vertical" type="chain" offsetFrom="V4" offset="40" />\n  <rect id="rect1" startXRuler="V2" startYRuler="H2" endXRuler="V1" endYRuler="H1"/>\n  <rect id="rect2" startXRuler="V5" startYRuler="H4" endXRuler="V3" endYRuler="H2"/>\n  <rect id="rect3" startXRuler="V1" startYRuler="H1" endX="15" endY="30"/>\n  <rect id="rect4" startXRuler="V1" startYRuler="H2" endXRuler="V0" endYRuler="H3"/>\n  <rect id="rect5" startX="300" startY="30" endX="380" endY="100"/>\n</root>';let M=null;k.addEventListener("click",(()=>{const t=P.value;try{const e=(new o).parse(t);M=new R(E,e),M.render()}catch(t){console.error("XML parsing/rendering failed:",t),alert("XML parsing/rendering failed.")}}))})();